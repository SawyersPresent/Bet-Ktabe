When a driver unloads, any resources it's holding must be freed to prevent leaks.  A pointer to a "cleanup" function must be provided in the DriverEntry by setting the **DriverUnload** property of the DriverObject.  The prototype is:

```
void DriverUnload(PDRIVER_OBJECT DriverObject);
```



Consider the following example:

```
#include <ntddk.h>

void DriverCleanup(PDRIVER_OBJECT DriverObject);

PVOID someAllocation;

extern "C"
NTSTATUS
DriverEntry(
	_In_ PDRIVER_OBJECT DriverObject,
	_In_ PUNICODE_STRING RegistryPath)
{
	UNREFERENCED_PARAMETER(RegistryPath);

	DbgPrint("[+] Hello from FirstDriver DriverEntry\n");

	DriverObject->DriverUnload = DriverCleanup;

	someAllocation = ExAllocatePoolWithTag(
		PagedPool,
		1024,
		'TAG1');

	DbgPrint("[+] Memory allocated at 0x%08p", someAllocation);

	return STATUS_SUCCESS;
}

void
DriverCleanup(
	PDRIVER_OBJECT DriverObject
)
{
	UNREFERENCED_PARAMETER(DriverObject);

	DbgPrint("[+] Hello from FirstDriver DriverUnload\n");
	DbgPrint("[+] Freeing memory at 0x%08p", someAllocation);

	ExFreePoolWithTag(
		someAllocation,
		'TAG1');

	DbgPrint("[+] Memory freed\n");
}
```



We're allocating a pool of memory inside DriverEntry using `ExAllocatePoolWithTag` and then ensuring to free it afterwards with `ExFreePoolWithTag`.



> **Note**:  If using the Windows 11 WDK on VS 2022 & Windows 10, you may see a deprecation warning for `ExAllocatePoolWithTag`.  Adding `#pragma warning(disable: 4996)` to the top of your code will remove this specific warning and allows the project to compile without having to disable "treat errors as warnings".



After building, starting, and stopping the driver, WinDbg shows the following output:

```
[+] Hello from FirstDriver DriverEntry
[+] Memory allocated at 0xFFFF958211F165A0
[+] Hello from FirstDriver DriverUnload
[+] Freeing memory at 0xFFFF958211F165A0
[+] Memory freed
```