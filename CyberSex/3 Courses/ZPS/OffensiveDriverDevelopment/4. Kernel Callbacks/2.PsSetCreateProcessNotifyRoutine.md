A driver may register the desired callbacks in DriverEntry, like so:

```
NTSTATUS status = PsSetCreateProcessNotifyRoutineEx(OnProcessNotify, FALSE);

if (!NT_SUCCESS(status))
{
	DbgPrint("PsSetCreateProcessNotifyRoutine failed (0x%08X)\n", status);
	PsSetCreateProcessNotifyRoutineEx(OnProcessNotify, TRUE);
}
```



The prototype for the function being pointed to is:

```
void OnProcessNotify(
    PEPROCESS Process,
    HANDLE ProcessId,
    PPS_CREATE_NOTIFY_INFO CreateInfo
);
```



A simple implementation may just print some information about the process being created:

```
void
OnProcessNotify(
	PEPROCESS Process,
	HANDLE ProcessId,
	PPS_CREATE_NOTIFY_INFO CreateInfo)
{
	UNREFERENCED_PARAMETER(Process);

	if (CreateInfo)
	{
		if (CreateInfo->FileOpenNameAvailable)
		{
			DbgPrint("[+] Process Created: %wZ (%d)\n", CreateInfo->ImageFileName, ProcessId);
		}
	}
}
```



After loading the driver:

```
[+] Process Created: \??\C:\Windows\system32\sppsvc.exe (4892)
[+] Process Created: \??\C:\Windows\system32\cmd.exe (5288)
[+] Process Created: \SystemRoot\System32\Conhost.exe (1456)
[+] Process Created: \??\C:\Windows\system32\wbem\wmiprvse.exe (5008)
[+] Process Created: \??\C:\Windows\system32\cmd.exe (2388)
[+] Process Created: \SystemRoot\System32\Conhost.exe (4388)
[+] Process Created: \??\C:\Windows\system32\hostname.EXE (4392)
```